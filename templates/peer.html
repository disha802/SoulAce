<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SoulAce - Peer Support</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{--accent-1:#7B9B8B;--accent-2:#243B36;--muted:#777}
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#F5F7F2; color:#333; transition:0.25s; padding-bottom:60px; }
    header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:var(--accent-1); }
    .header-left { display:flex; align-items:center; gap:15px; }
    .header-text h1 { margin:0; font-size:1.4rem; color:#fff; }
    .header-text h3 { margin:0; font-size:0.85rem; color:#FFF7E4; }
    .logo-container img { width:52px; height:52px; border-radius:8px; object-fit:cover; }
    .user-icon { width:40px; height:40px; border-radius:50%; cursor:pointer; }
    .user-popup {display: none;position: absolute;top: 60px;right: 20px; background: #fff; border-radius: 12px; padding: 10px; min-width: 160px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); z-index: 1000;}
    .popup-btn { display:block; width:100%; margin-bottom:8px; background:#fff; color:var(--accent-2); font-weight:600; padding:8px; border:none; border-radius:8px; cursor:pointer; text-align:left }
    .popup-btn:hover { background:#f2f2f2; }
    main { padding:1.5rem; max-width:1100px; margin:0 auto; }
    h2 { color:var(--accent-2); }

    input, textarea, select { width:100%; padding:12px; margin:8px 0; border-radius:10px; border:1px solid #ccc; font-size:1rem; box-sizing:border-box; }
    textarea { min-height:100px; resize:vertical; }
    button { background:linear-gradient(135deg, #657A74 , var(--accent-2)); color:#fff; font-size:15px; font-weight:600; padding:8px 14px; border:none; border-radius:8px; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.12); transition:all 0.18s ease; }
    button:hover { transform:translateY(-2px); }
    button.secondary { background:#E0E0E0; color:#333; }
    button.danger { background:#f8f8f8; color:#b33a3a; border:1px solid #b33a3a; }

    .forum-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; flex-wrap:wrap; }
    .search-container { display:flex; gap:10px; margin:6px 0; align-items:center; }
    .post-form { background:white; padding:16px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:20px; }
    .post-form h3 { margin-top:0; color:var(--accent-2); }
    .anonymity-toggle { display:flex; align-items:center; gap:8px; margin:10px 0; }

    .post { background:white; padding:16px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:14px; }
    .post-header { display:flex; justify-content:space-between; margin-bottom:8px; }
    .post-author { font-weight:700; color:var(--accent-2); display:flex; align-items:center; gap:8px }
    .post-date { color:var(--muted); font-size:0.9rem; }
    .post-content { margin:10px 0; line-height:1.45; white-space:pre-wrap; }
    .post-actions { display:flex; gap:12px; margin-top:8px; align-items:center; flex-wrap:wrap }
    .action-btn { display:flex; align-items:center; gap:6px; background:none; border:none; color:#657A74; cursor:pointer; padding:6px 8px; border-radius:6px; }
    .action-btn:hover { background:#f5f5f5; }
    .action-btn.liked { color:#D64B4B; }
    .action-btn.disliked { color:#4B69D6; }

    .replies { margin-left:18px; margin-top:12px; }
    .reply-form { margin-top:12px; display:none; }
    .reply { background:#F9F9F9; padding:12px; border-radius:8px; margin-bottom:10px; border-left:3px solid var(--accent-1); }
    .reply-header { display:flex; justify-content:space-between; margin-bottom:6px; }
    .reply-author { font-weight:600; color:var(--accent-2); font-size:0.95rem; }
    .reply-date { color:var(--muted); font-size:0.82rem; }
    .reply-actions { display:flex; gap:10px; margin-top:8px; }

    .studentvol-badge { background: linear-gradient(135deg, #FFD700, #FFA500); color:#000; font-size:0.7rem; font-weight:700; padding:2px 8px; border-radius:10px; }
    .ai-flag-badge { background: linear-gradient(135deg, #ff6b6b, #c53030); color:white; font-size:0.7rem; font-weight:700; padding:2px 8px; border-radius:10px; }
    .manual-flag-badge { background: linear-gradient(135deg, #4b69d6, #2c3e99); color:white; font-size:0.7rem; font-weight:700; padding:2px 8px; border-radius:10px; }
    .flagged { background-color:#fff0f0; border-left:3px solid #ff6b6b; }
    .ai-flagged { background-color:#fff0f0; border-left:3px solid #ff6b6b; }
    .manual-flagged { background-color:#f0f0ff; border-left:3px solid #4b69d6; }
    .deleted { font-style:italic; color:gray; }

    .moderation-actions { display:flex; gap:8px; margin-top:8px }

    /* Filter styles */
    .filter-container { display:flex; gap:10px; margin:6px 0; align-items:center; }
    .filter-select { width:auto; padding:8px 12px; }
    .filter-active { background-color:var(--accent-2); color:white; }

   footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  background: #FFE5B4;
  text-align: center;
  padding: 10px;
}


    /* Dark Mode Styles */
    body.dark-mode {
      --accent-1: #5a7a6a;
      --accent-2: #1a2b26;
      --muted: #9ca3af;
      background: #0f1112;
      color: #e6e6e6;
    }

    body.dark-mode header {
      background: #1f2937;
    }

    body.dark-mode .header-text h1 {
      color: #f3f4f6;
    }

    body.dark-mode .header-text h3 {
      color: #d1d5db;
    }

    body.dark-mode .user-popup {
      background: #374151;
      color: #f3f4f6;
      border: 1px solid #4b5563;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    body.dark-mode .popup-btn {
      background: #1f2937;
      color: #f3f4f6;
      border: 1px solid #4b5563;
    }

    body.dark-mode .popup-btn:hover {
      background: #111827;
    }

    body.dark-mode #lang-select {
      background: #1f2937;
      color: #f3f4f6;
      border-color: #4b5563;
    }

    body.dark-mode main {
      color: #e6e6e6;
    }

    body.dark-mode h2 {
      color: #f3f4f6;
    }

    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select {
      background: #1f2937;
      color: #f3f4f6;
      border-color: #4b5563;
    }

    body.dark-mode input::placeholder,
    body.dark-mode textarea::placeholder {
      color: #9ca3af;
    }

    body.dark-mode button {
      background: linear-gradient(135deg, #4b5563, #1f2937);
      color: #f3f4f6;
    }

    body.dark-mode button.secondary {
      background: #4b5563;
      color: #f3f4f6;
    }

    body.dark-mode button.secondary:hover {
      background: #374151;
    }

    body.dark-mode button.danger {
      background: #1f2937;
      color: #ef4444;
      border-color: #ef4444;
    }

    body.dark-mode button.danger:hover {
      background: #7f1d1d;
      color: #fca5a5;
    }

    body.dark-mode .post,
    body.dark-mode .post-form {
      background: #1e1e1f;
      color: #e6e6e6;
      border: 1px solid #374151;
    }

    body.dark-mode .post-author {
      color: #f3f4f6;
    }

    body.dark-mode .post-date,
    body.dark-mode .reply-date {
      color: var(--muted);
    }

    body.dark-mode .post-content {
      color: #e6e6e6;
    }

    body.dark-mode .action-btn {
      color: #9ca3af;
    }

    body.dark-mode .action-btn:hover {
      background: #374151;
      color: #f3f4f6;
    }

    body.dark-mode .action-btn.liked {
      color: #ef4444;
    }

    body.dark-mode .action-btn.disliked {
      color: #3b82f6;
    }

    body.dark-mode .reply {
      background: #232323;
      border-left-color: #4b5563;
      color: #e6e6e6;
    }

    body.dark-mode .reply-author {
      color: #f3f4f6;
    }

    body.dark-mode .filter-select {
      background: #1f2937;
      color: #f3f4f6;
      border-color: #4b5563;
    }

    body.dark-mode .filter-active {
      background-color: #1f2937;
      color: #f3f4f6;
    }

    body.dark-mode .studentvol-badge {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #000;
    }

    body.dark-mode .ai-flag-badge {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
    }

    body.dark-mode .manual-flag-badge {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
    }

    body.dark-mode .ai-flagged {
      background-color: #1f1315;
      border-left-color: #ef4444;
    }

    body.dark-mode .manual-flagged {
      background-color: #131720;
      border-left-color: #3b82f6;
    }

    body.dark-mode .deleted {
      color: #6b7280;
    }

    body.dark-mode footer {
      background: #111827;
      border-top-color: #374151;
      color: #9ca3af;
    }

    body.dark-mode .anonymity-toggle label {
      color: #e6e6e6;
    }

    body.dark-mode .search-container input {
      background: #1f2937;
      color: #f3f4f6;
      border-color: #4b5563;
    }

    /* Language-specific text direction (minimal RTL) */
    html[lang="ur"] .post-content,
    html[lang="ur"] .reply-content,
    html[lang="ur"] input,
    html[lang="ur"] textarea {
      direction: rtl;
      text-align: right;
    }

    /* Smooth transitions */
    body, .post, .post-form, .reply, .user-popup, input, textarea, select, button {
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    @media (max-width: 768px) {
      .forum-header { flex-direction:column; align-items:flex-start; gap:12px }
      .replies { margin-left:10px }
      .filter-container { flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div>
<header>
  <div class="header-left">
    <div class="logo-container">
      <img src="{{ url_for('static', filename='header-logo.png') }}" alt="SoulAce Logo">
    </div>
    <div class="header-text">
      <h1 >SoulAce</h1>
      <h3 >Wellness begins here</h3>
    </div>
  </div>

  <div class="header-right">
    <div class="user-icon-container" style="position: relative;">
      <img src="{{ url_for('static', filename='user-icon.jpeg') }}" 
           alt="User Icon" 
           class="user-icon" 
           onclick="toggleUserPopup()">

      <div id="user-popup" class="user-popup" style="display: none;">
        <!-- Google Translate -->
        <div id="google_translate_element" style="margin-bottom:10px;"></div>
        <div style="margin-bottom:10px;">
        </div>
        <button onclick="location.href='{{ url_for('dashboard') }}'" class="popup-btn">üè† Home</button>
        <button onclick="toggleMode()" class="popup-btn">üåô Change Mode</button>
        <form action="{{ url_for('logout') }}" method="POST" style="margin:0;">
          <button type="submit" class="popup-btn">üö™ Logout</button>
        </form>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="forum-header">
    <h2 data-en="Peer Support Forum">Peer Support Forum</h2>
    <div>
      <button onclick="showPostForm()" data-en="+ New Post">+ New Post</button>
    </div>
  </div>

  <div class="search-container">
    <input type="text" id="search-input" placeholder="Search posts, titles or users...">
    <button onclick="searchPosts()">Search</button>
    <button onclick="clearSearch()" class="secondary">Clear</button>
  </div>

  <!-- Filter container (only shown to Student Volunteers) -->
  <div id="filter-container" class="filter-container" style="display:none;">
    <span>Filter by:</span>
    <select id="post-filter" class="filter-select" onchange="applyFilter()">
      <option value="all">All Posts</option>
      <option value="flagged" >Flagged Posts</option>
      <option value="ai-flagged" >AI Moderated</option>
    </select>
  </div>

  <!-- Post form -->
  <div id="post-form" class="post-form" style="display:none;">
    <h3 >Create a New Post</h3>
    <input type="text" id="post-title" placeholder="Post title" required>
    <textarea id="post-content" placeholder="Share your thoughts..."></textarea>
    <div class="anonymity-toggle">
      <input type="checkbox" id="anonymous-toggle">
      <label for="anonymous-toggle">Post anonymously</label>
    </div>
    <div style="display:flex; gap:10px;">
      <button onclick="submitPost()">Submit Post</button>
      <button onclick="hidePostForm()" class="secondary" >Cancel</button>
    </div>
  </div>

  <div id="posts-container">
    <!-- Posts will be loaded here -->
  </div>
</main>

<footer>
  <p>
      SoulAce ¬© 2025 ‚Äî Built with üíô by SynapSix
  </p>
</footer>
</div>
<script>
// Complete JavaScript with working language switching
let posts = [];
let allPosts = [];
let currentUser = null;
let currentFilter = 'all';
let currentLanguage = 'en';

// Language switching functionality
function initLanguageSwitch() {
  const langSelect = document.getElementById('lang-select');
  if (!langSelect) return;

  const savedLang = localStorage.getItem('soulace-language') || 'en';
  currentLanguage = savedLang;
  langSelect.value = savedLang;

  langSelect.addEventListener('change', function() {
    const newLang = this.value;
    changeLanguage(newLang);
  });

  if (savedLang !== 'en') {
    changeLanguage(savedLang);
  }
}

function changeLanguage(lang) {
  currentLanguage = lang;
  localStorage.setItem('soulace-language', lang);
  
  updateElementTexts(lang);
  updatePlaceholderTexts(lang);
  handleRTL(lang);
  updateDynamicTexts(lang);
}

function updateElementTexts(lang) {
  const elements = document.querySelectorAll('[data-en]');
  elements.forEach(element => {
    const text = element.getAttribute(`data-${lang}`);
    if (text) {
      if (element.tagName === 'INPUT' && element.type === 'submit') {
        element.value = text;
      } else {
        element.textContent = text;
      }
    }
  });
}

function updatePlaceholderTexts(lang) {
  const placeholders = {
    'search-input': {
      en: 'Search posts, titles or users...',
      ur: 'ŸæŸàÿ≥Ÿπÿ≥ÿå Ÿπÿßÿ¶ŸπŸÑÿ≤ €åÿß ÿµÿßÿ±ŸÅ€åŸÜ ÿ™ŸÑÿßÿ¥ ⁄©ÿ±€å⁄∫...',
      hi: '‡§™‡•ã‡§∏‡•ç‡§ü, ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§Ø‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ñ‡•ã‡§ú‡•á‡§Ç...'
    },
    'post-title': {
      en: 'Post title',
      ur: 'ŸæŸàÿ≥Ÿπ ⁄©ÿß ÿπŸÜŸàÿßŸÜ',
      hi: '‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï'
    },
    'post-content': {
      en: 'Share your thoughts...',
      ur: 'ÿßŸæŸÜ€í ÿÆ€åÿßŸÑÿßÿ™ ÿ¥€åÿ¶ÿ± ⁄©ÿ±€å⁄∫...',
      hi: '‡§Ö‡§™‡§®‡•á ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç...'
    }
  };

  Object.keys(placeholders).forEach(id => {
    const element = document.getElementById(id);
    if (element && placeholders[id][lang]) {
      element.placeholder = placeholders[id][lang];
    }
  });
}

function handleRTL(lang) {
  // Minimal RTL - only set language attribute, no layout changes
  document.documentElement.setAttribute('lang', lang);
}

function updateDynamicTexts(lang) {
  // Update buttons without data attributes
  const buttonTexts = {
    '+ New Post': { ur: '+ ŸÜÿ¶€å ŸæŸàÿ≥Ÿπ', hi: '+ ‡§®‡§à ‡§™‡•ã‡§∏‡•ç‡§ü' },
    'Search': { ur: 'ÿ™ŸÑÿßÿ¥ ⁄©ÿ±€å⁄∫', hi: '‡§ñ‡•ã‡§ú‡•á‡§Ç' },
    'Clear': { ur: 'ÿµÿßŸÅ ⁄©ÿ±€å⁄∫', hi: '‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç' },
    'Submit Post': { ur: 'ŸæŸàÿ≥Ÿπ ÿ¨ŸÖÿπ ⁄©ÿ±€å⁄∫', hi: '‡§™‡•ã‡§∏‡•ç‡§ü ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç' },
    'Cancel': { ur: 'ŸÖŸÜÿ≥ŸàÿÆ ⁄©ÿ±€å⁄∫', hi: '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç' }
  };

  document.querySelectorAll('button').forEach(button => {
    const currentText = button.textContent.trim();
    if (buttonTexts[currentText] && buttonTexts[currentText][lang]) {
      button.textContent = buttonTexts[currentText][lang];
    }
  });
}

// User popup functionality
function toggleUserPopup() {
  const popup = document.getElementById('user-popup');
  if (popup) {
    const isVisible = popup.style.display === 'block';
    popup.style.display = isVisible ? 'none' : 'block';
  }
}

function toggleMode() {
  document.body.classList.toggle('dark-mode');
}

// Click outside to close popup
document.addEventListener('click', function(event) {
  const popup = document.getElementById('user-popup');
  const userIcon = document.querySelector('.user-icon');
  
  if (popup && popup.style.display === 'block') {
    if (!popup.contains(event.target) && !userIcon.contains(event.target)) {
      popup.style.display = 'none';
    }
  }
});
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchPosts();
      }
    });
  }
});

// Forum functionality
function normalizePosts(raw) {
  return raw.map(p => {
    const postId = p._id || p.id || p.post_id || p._id?.$oid || null;
    const replies = (p.replies || []).map(r => ({
      id: r._id || r.id || r.reply_id || null,
      user_id: r.user_id || r.userId || r.uid || null,
      author: r.username || r.author || (r.user && r.user.username) || 'Anonymous',
      anonymous: r.is_anonymous || r.anonymous || r.isAnonymous || false,
      content: r.content || r.text || '',
      likes: Array.isArray(r.likes) ? r.likes.length : (r.likes || 0),
      dislikes: Array.isArray(r.dislikes) ? r.dislikes.length : (r.dislikes || 0),
      liked: r.liked || false,
      disliked: r.disliked || false,
      flagged: !!r.flagged,
      ai_flagged: !!r.ai_flagged,
      flag_categories: r.flag_categories || [],
      is_deleted: !!r.is_deleted,
      date: r.date || r.created_at || '',
      time: r.time || r.created_time || '',
      datetime: r.datetime ? new Date(r.datetime) : (r.date && r.time ? new Date(`${r.date}T${r.time}`) : new Date()),
      isstudentvol: !!r.isstudentvol
    }));

    let postDatetime;
    if (p.datetime) {
      postDatetime = new Date(p.datetime);
    } else if (p.date && p.time) {
      postDatetime = new Date(`${p.date}T${p.time}`);
    } else {
      postDatetime = new Date();
    }

    return {
      id: postId,
      _id: postId,
      user_id: p.user_id || p.userid || p.userId || null,
      title: p.title || '',
      content: p.content || p.text || '',
      username: p.username || p.author || (p.user && p.user.username) || 'Anonymous',
      is_anonymous: !!p.is_anonymous || !!p.anonymous,
      is_deleted: !!p.is_deleted,
      likes: Array.isArray(p.likes) ? p.likes.length : (p.likes || 0),
      dislikes: Array.isArray(p.dislikes) ? p.dislikes.length : (p.dislikes || 0),
      liked: p.liked || false,
      disliked: p.disliked || false,
      flagged: !!p.flagged,
      ai_flagged: !!p.ai_flagged,
      flag_categories: p.flag_categories || [],
      replies: replies,
      date: p.date || p.created_date || postDatetime.toISOString().split('T')[0],
      time: p.time || p.created_time || postDatetime.toTimeString().split(' ')[0],
      datetime: postDatetime,
      isstudentvol: !!p.isstudentvol
    };
  });
}

function formatDateTime(dateTime) {
  if (!dateTime) return '';
  
  const dateObj = new Date(dateTime);
  if (isNaN(dateObj.getTime())) return '';
  
  const now = new Date();
  const diffMs = now - dateObj;
  const diffMins = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  let relativeTime = '';
  if (diffMins < 1) relativeTime = 'Just now';
  else if (diffMins < 60) relativeTime = `${diffMins} min ago`;
  else if (diffHours < 24) relativeTime = `${diffHours} hr ago`;
  else if (diffDays < 7) relativeTime = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
  else relativeTime = dateObj.toLocaleDateString();
  
  const exactTime = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  
  return `<span title="${exactTime}">${relativeTime}</span>`;
}

// Initialize on page load
document.addEventListener("DOMContentLoaded", async () => {
  initLanguageSwitch();
  
  try {
    const res = await fetch('/session_info');
    if (res.ok) {
      currentUser = await res.json();
      if (currentUser) {
        currentUser.role = currentUser.role || currentUser.user_type || currentUser.type || null;
        currentUser.username = currentUser.username || currentUser.name || currentUser.user || 'You';
        
        if (isstudentvol(currentUser)) {
          document.getElementById('filter-container').style.display = 'flex';
        }
      }
    }
  } catch (err) {
    console.error('Failed to fetch session info', err);
  }

  await loadPosts();
});

async function loadPosts() {
  try {
    const res = await fetch('/peer_data');
    if (!res.ok) {
      console.error('Failed to /peer_data:', res.status);
      renderPosts(posts);
      return;
    }
    const data = await res.json();
    allPosts = normalizePosts(data || []);
    applyFilter();
  } catch (err) {
    console.error('Failed to load posts', err);
  }
}

function applyFilter() {
  const filterValue = document.getElementById('post-filter').value;
  currentFilter = filterValue;
  
  const filterSelect = document.getElementById('post-filter');
  Array.from(filterSelect.options).forEach(option => {
    if (option.value === filterValue) {
      option.classList.add('filter-active');
    } else {
      option.classList.remove('filter-active');
    }
  });
  
  if (filterValue === 'flagged') {
    posts = allPosts.filter(post => post.flagged && !post.is_deleted);
  } else if (filterValue === 'ai-flagged') {
    posts = allPosts.filter(post => post.ai_flagged && !post.is_deleted);
  } else {
    posts = [...allPosts];
  }
  renderPosts(posts);
}

function isstudentvol(user) {
  return user && (user.role === 'studentvol' || user.role === 'Volunteer');
}

function showPostForm() { 
  document.getElementById('post-form').style.display = 'block'; 
  window.scrollTo({top:0,behavior:'smooth'}); 
}

function hidePostForm(){ 
  document.getElementById('post-form').style.display = 'none'; 
  document.getElementById('post-title').value=''; 
  document.getElementById('post-content').value=''; 
  document.getElementById('anonymous-toggle').checked=false; 
}

async function submitPost(){
  const title = document.getElementById('post-title').value.trim();
  const content = document.getElementById('post-content').value.trim();
  const is_anonymous = document.getElementById('anonymous-toggle').checked;
  if (!content) { alert('Please enter some content before posting.'); return; }

  try {
    const res = await fetch('/add_post', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ title, content, is_anonymous })
    });
    if (res.ok) {
      hidePostForm();
      await loadPosts();
    } else {
      const text = await res.text();
      console.error('Failed to add post:', text);
      alert('Failed to add post: ' + text);
    }
  } catch (err) {
    console.error('Error adding post', err);
  }
}

async function likePost(id, action='like'){
  try{
    const res = await fetch(`/like_post/${id}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action }) });
    if(res.ok) await loadPosts(); else console.error('Failed like_post', await res.text());
  }catch(e){console.error(e)}
}

async function likeReply(postId, replyId, action='like'){
  try{
    const res = await fetch(`/like_reply/${postId}/${replyId}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action }) });
    if(res.ok) await loadPosts(); else console.error('Failed like_reply', await res.text());
  }catch(e){console.error(e)}
}

function toggleReplyForm(postId){
  const el = document.getElementById(`reply-form-${postId}`);
  if(!el) return;
  el.style.display = (el.style.display === 'block') ? 'none' : 'block';
}

async function submitReply(postId){
  const textarea = document.getElementById(`reply-content-${postId}`);
  const anonBox = document.getElementById(`reply-anonymous-${postId}`);
  if(!textarea) return; 
  const content = textarea.value.trim();
  if(!content){ alert('Reply cannot be empty.'); return; }

  try{
    const res = await fetch(`/add_reply/${postId}`, {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({ reply: content, is_anonymous: !!(anonBox && anonBox.checked) })
    });
    if(res.ok){ await loadPosts(); } else { console.error('Failed add_reply', await res.text()); }
  }catch(e){console.error(e)}
}

async function deletePost(postId){
  if(!confirm('Are you sure you want to delete this post?')) return;
  try{
    const res = await fetch(`/delete_post/${postId}`, { method:'DELETE' });
    if(res.ok) {
      await loadPosts();
      if (currentFilter !== 'all') {
        applyFilter();
      }
    } else { 
      const txt = await res.text(); 
      alert('Failed to delete post: '+txt); 
    }
  }catch(e){console.error(e)}
}

async function deleteReply(postId, replyId){
  if(!confirm('Are you sure you want to delete this reply?')) return;
  try{
    const res = await fetch(`/delete_reply/${postId}/${replyId}`, { method:'DELETE' });
    if(res.ok) {
      await loadPosts();
      if (currentFilter !== 'all') {
        applyFilter();
      }
    } else { 
      const txt = await res.text(); 
      alert('Failed to delete reply: '+txt); 
    }
  }catch(e){console.error(e)}
}

async function flagContent(contentType, contentId, postId=null){
  if(!currentUser) { alert('You must be logged in to flag content.'); return; }
  if(!isstudentvol(currentUser)){ alert('Only Student Volunteers can flag content.'); return; }
  if(!confirm('Flag this content as inappropriate?')) return;
  try{
    const endpoint = `/flag_content/${contentType}/${contentId}`;
    const res = await fetch(endpoint, { method:'POST' });
    if(res.ok){ alert('Content flagged successfully'); await loadPosts(); } else { alert('Failed to flag content: ' + await res.text()); }
  }catch(e){console.error(e)}
}

async function unflagContent(contentType, contentId, postId=null){
  if(!currentUser) { alert('You must be logged in to unflag content.'); return; }
  if(!isstudentvol(currentUser) && currentUser.role !== 'Admin'){ 
    alert('Only Student Volunteers and Admins can unflag content.'); 
    return; 
  }
  if(!confirm('Unflag this content?')) return;
  try{
    const endpoint = `/unflag_content/${contentType}/${contentId}`;
    const res = await fetch(endpoint, { method:'POST' });
    if(res.ok){ alert('Content unflagged successfully'); await loadPosts(); } else { alert('Failed to unflag content: ' + await res.text()); }
  }catch(e){console.error(e)}
}

function searchPosts(){
  const q = document.getElementById('search-input').value.toLowerCase().trim();
   console.log('Search query:', q);
  console.log('All posts:', allPosts.length);
  if(!q){ 
    applyFilter();
    return; 
  }
  
  let basePosts = [...allPosts];
  if (currentFilter === 'flagged') {
    basePosts = basePosts.filter(post => post.flagged && !post.is_deleted);
  } else if (currentFilter === 'ai-flagged') {
    basePosts = basePosts.filter(post => post.ai_flagged && !post.is_deleted);
  }
  
  console.log('Base posts for search:', basePosts.length);
  posts = basePosts.filter(post => {
    const title = (post.title || '').toLowerCase();
    const content = (post.content || '').toLowerCase();
    const author = post.is_anonymous ? '' : (post.username || post.author || '').toLowerCase();
    const inTitle = (post.title||'').toLowerCase().includes(q);
    const inContent = (post.content||'').toLowerCase().includes(q);
    const inAuthor = (!post.is_anonymous && (post.username||'').toLowerCase().includes(q));
    const inReplies = (post.replies || []).some(r => {
      const replyContent = (r.content || '').toLowerCase();
      const replyAuthor = r.anonymous ? '' : (r.author || r.username || '').toLowerCase();
      return replyContent.includes(q) || replyAuthor.includes(q);
    });
     const found = inTitle || inContent || inAuthor || inReplies;
      if (found) {
      console.log('Found match in post:', {
        title: post.title,
        matchedIn: {
          title: inTitle,
          content: inContent, 
          author: inAuthor,
          replies: inReplies
        }
      });
    }
    
    return found;
  });
  
  console.log('Search results:', posts.length);
  renderPosts(posts);
}

function clearSearch(){ 
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.value = ''; 
  }
  applyFilter();
}

function sortReplies(replies){
  return replies.sort((a,b)=>{
    if(!!a.isstudentvol && !b.isstudentvol) return -1;
    if(!a.isstudentvol && !!b.isstudentvol) return 1;
    const aNet = (a.likes||0) - (a.dislikes||0);
    const bNet = (b.likes||0) - (b.dislikes||0);
    if(aNet !== bNet) return bNet - aNet;
    const aDate = a.datetime ? new Date(a.datetime) : new Date();
    const bDate = b.datetime ? new Date(b.datetime) : new Date();
    return bDate - aDate;
  });
}

function canDeletePost(post){
  if(!currentUser) return false;
  const isOwner = currentUser.user_id == post.user_id || currentUser.user_id == post.userId || currentUser.user_id == post.user_id;
  const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'admin';
  const isVolunteer = isstudentvol(currentUser);
  return isOwner || isAdmin || isVolunteer;
}

function canDeleteReply(reply){
  if(!currentUser) return false;
  const isOwner = currentUser.user_id == reply.user_id || currentUser.user_id == reply.userId;
  const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'admin';
  const isVolunteer = isstudentvol(currentUser);
  return isOwner || isAdmin || isVolunteer;
}

function renderPosts(postsArray){
  const container = document.getElementById('posts-container');
  container.innerHTML = '';
  
  if(!postsArray || postsArray.length===0){
    if (currentFilter === 'flagged') {
      container.innerHTML = '<p>No flagged posts found.</p>';
    } else if (currentFilter === 'ai-flagged') {
      container.innerHTML = '<p>No AI-moderated posts found.</p>';
    } else {
      container.innerHTML = '<p>No posts yet. Be the first to share!</p>';
    }
    return; 
  }

  postsArray.forEach(p => {
    const postEl = document.createElement('div');
    postEl.className = 'post' + (p.flagged ? (p.ai_flagged ? ' ai-flagged' : ' manual-flagged') : '');

    const postHeader = document.createElement('div'); 
    postHeader.className = 'post-header';
    const authorSpan = document.createElement('span'); 
    authorSpan.className = 'post-author';
    const displayName = p.is_anonymous ? 'Anonymous' : (p.username || 'Unknown');
    
    let flagBadges = '';
    if (p.flagged) {
      if (p.ai_flagged) {
        flagBadges = '<span class="ai-flag-badge">AI Moderator</span>';
      } else {
        flagBadges = '<span class="manual-flag-badge">Manually Flagged</span>';
      }
    }
    
    authorSpan.innerHTML = `${escapeHtml(displayName)} ${p.isstudentvol?'<span class="studentvol-badge">Student Volunteer</span>':''} ${flagBadges}`;
    
    const dateSpan = document.createElement('span'); 
    dateSpan.className = 'post-date'; 
    dateSpan.innerHTML = formatDateTime(p.datetime);
    postHeader.appendChild(authorSpan); 
    postHeader.appendChild(dateSpan);

    const titleEl = document.createElement('h3');
    titleEl.style.marginTop = '8px';
titleEl.style.marginBottom = '8px';
titleEl.style.color = 'var(--accent-2)';
    titleEl.textContent = p.title || '';
    const contentDiv = document.createElement('div'); 
    contentDiv.className = 'post-content';
    contentDiv.innerHTML = p.is_deleted ? `<p class="deleted">${escapeHtml(p.content)}</p>` : escapeHtml(p.content);

    if (p.ai_flagged && p.flag_categories && p.flag_categories.length > 0) {
      const categoriesDiv = document.createElement('div');
      categoriesDiv.style.marginTop = '8px';
      categoriesDiv.style.fontSize = '0.85rem';
      categoriesDiv.style.color = '#d32f2f';
      categoriesDiv.innerHTML = `<strong>AI detected:</strong> ${p.flag_categories.join(', ')}`;
      contentDiv.appendChild(categoriesDiv);
    }

    const actionsDiv = document.createElement('div'); 
    actionsDiv.className = 'post-actions';
    const likeBtn = document.createElement('button'); 
    likeBtn.className = 'action-btn ' + (p.liked ? 'liked' : ''); 
    likeBtn.innerHTML = `üëç ${p.likes||0}`;
    likeBtn.onclick = () => likePost(p.id || p._id);
    const dislikeBtn = document.createElement('button'); 
    dislikeBtn.className = 'action-btn ' + (p.disliked ? 'disliked' : ''); 
    dislikeBtn.innerHTML = `üëé ${p.dislikes||0}`;
    dislikeBtn.onclick = () => { likePost(p.id || p._id, 'dislike'); };
    const replyToggle = document.createElement('button'); 
    replyToggle.className = 'action-btn'; 
    replyToggle.innerHTML = 'üí¨ Reply'; 
    replyToggle.onclick = () => toggleReplyForm(p.id || p._id);
    
    actionsDiv.appendChild(likeBtn); 
    actionsDiv.appendChild(dislikeBtn); 
    actionsDiv.appendChild(replyToggle);

    if((isstudentvol(currentUser) || currentUser?.role === 'Admin') && !p.is_deleted){
      if (p.flagged) {
        const unflagBtn = document.createElement('button'); 
        unflagBtn.className = 'action-btn'; 
        unflagBtn.innerHTML = '‚úÖ Unflag';
        unflagBtn.onclick = () => unflagContent('post', p.id || p._id);
        actionsDiv.appendChild(unflagBtn);
      } else {
        const flagBtn = document.createElement('button'); 
        flagBtn.className = 'action-btn'; 
        flagBtn.innerHTML = 'üö© Flag';
        flagBtn.onclick = () => flagContent('post', p.id || p._id);
        actionsDiv.appendChild(flagBtn);
      }
      const delBtn = document.createElement('button'); 
      delBtn.className = 'action-btn danger'; 
      delBtn.innerHTML = 'üóëÔ∏è Delete'; 
      delBtn.onclick = () => deletePost(p.id || p._id);
      actionsDiv.appendChild(delBtn);
    } else if(canDeletePost(p) && !p.is_deleted){
      const delBtn = document.createElement('button'); 
      delBtn.className = 'action-btn danger'; 
      delBtn.innerHTML = 'üóëÔ∏è Delete'; 
      delBtn.onclick = () => deletePost(p.id || p._id);
      actionsDiv.appendChild(delBtn);
    }

    postEl.appendChild(postHeader);   
    postEl.appendChild(contentDiv);
    postEl.appendChild(actionsDiv);
if (p.title && p.title.trim() !== '') {
    titleEl.textContent = p.title.trim();
    titleEl.style.display = 'block';
    postEl.appendChild(titleEl);
} else {
    // Optional: Show a default title or hide completely
    titleEl.style.display = 'none';
}
    const replyForm = document.createElement('div'); 
    replyForm.id = `reply-form-${p.id||p._id}`; 
    replyForm.className = 'reply-form'; 
    replyForm.style.display = 'none';
    replyForm.innerHTML = `
      <textarea id="reply-content-${p.id||p._id}" placeholder="Write your reply..."></textarea>
      <div class="anonymity-toggle">
        <input type="checkbox" id="reply-anonymous-${p.id||p._id}">
        <label for="reply-anonymous-${p.id||p._id}">Reply anonymously</label>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="submitReply('${p.id||p._id}')">Submit Reply</button>
        <button onclick="toggleReplyForm('${p.id||p._id}')" class="secondary">Cancel</button>
      </div>
    `;
    postEl.appendChild(replyForm);

    const repliesWrap = document.createElement('div'); 
    repliesWrap.className = 'replies';
    const sorted = sortReplies((p.replies||[]).map(r=>({ ...r })));
    sorted.forEach(r => {
      const replyEl = document.createElement('div'); 
      replyEl.className = 'reply' + (r.flagged ? (r.ai_flagged ? ' ai-flagged' : ' manual-flagged') : '');
      
      const header = document.createElement('div'); 
      header.className = 'reply-header';
      let replyFlagBadges = '';
      if (r.flagged) {
        if (r.ai_flagged) {
          replyFlagBadges = '<span class="ai-flag-badge">AI Moderator</span>';
        } else {
          replyFlagBadges = '<span class="manual-flag-badge">Manually Flagged</span>';
        }
      }
      
      const author = document.createElement('span'); 
      author.className = 'reply-author'; 
      author.innerHTML = `${r.anonymous ? 'Anonymous' : escapeHtml(r.author||'Unknown')} ${r.isstudentvol?'<span class="studentvol-badge">Student Volunteer</span>':''} ${replyFlagBadges}`;
      const date = document.createElement('span'); 
      date.className = 'reply-date'; 
      date.innerHTML = formatDateTime(r.datetime);
      header.appendChild(author); 
      header.appendChild(date);

      const contentDiv = document.createElement('div'); 
      contentDiv.className = 'reply-content'; 
      contentDiv.innerHTML = r.is_deleted ? `<p class="deleted">${escapeHtml(r.content)}</p>` : escapeHtml(r.content);

      if (r.ai_flagged && r.flag_categories && r.flag_categories.length > 0) {
        const categoriesDiv = document.createElement('div');
        categoriesDiv.style.marginTop = '8px';
        categoriesDiv.style.fontSize = '0.85rem';
        categoriesDiv.style.color = '#d32f2f';
        categoriesDiv.innerHTML = `<strong>AI detected:</strong> ${r.flag_categories.join(', ')}`;
        contentDiv.appendChild(categoriesDiv);
      }

      const actions = document.createElement('div'); 
      actions.className = 'reply-actions';
      const likeR = document.createElement('button'); 
      likeR.className = 'action-btn '+(r.liked?'liked':''); 
      likeR.innerHTML = `üëç ${r.likes||0}`; 
      likeR.onclick = () => likeReply(p.id||p._id, r.id, 'like');
      const disR = document.createElement('button'); 
      disR.className = 'action-btn '+(r.disliked?'disliked':''); 
      disR.innerHTML = `üëé ${r.dislikes||0}`; 
      disR.onclick = () => likeReply(p.id||p._id, r.id, 'dislike');
      actions.appendChild(likeR); 
      actions.appendChild(disR);

      if(!r.is_deleted) {
        if((isstudentvol(currentUser) || currentUser?.role === 'Admin')){ 
          if (r.flagged) {
            const unflagR = document.createElement('button'); 
            unflagR.className = 'action-btn'; 
            unflagR.innerHTML = '‚úÖ Unflag'; 
            unflagR.onclick = () => unflagContent('reply', r.id, p.id||p._id); 
            actions.appendChild(unflagR); 
          } else {
            const flagR = document.createElement('button'); 
            flagR.className = 'action-btn'; 
            flagR.innerHTML = 'üö© Flag'; 
            flagR.onclick = () => flagContent('reply', r.id, p.id||p._id); 
            actions.appendChild(flagR); 
          }
          const delR = document.createElement('button'); 
          delR.className='action-btn danger'; 
          delR.innerHTML='üóëÔ∏è Delete'; 
          delR.onclick=()=> deleteReply(p.id||p._id, r.id); 
          actions.appendChild(delR); 
        }
        else if(canDeleteReply(r)){ 
          const delR = document.createElement('button'); 
          delR.className='action-btn danger'; 
          delR.innerHTML='üóëÔ∏è Delete'; 
          delR.onclick=()=> deleteReply(p.id||p._id, r.id); 
          actions.appendChild(delR); 
        }
      }

      replyEl.appendChild(header); 
      replyEl.appendChild(contentDiv); 
      replyEl.appendChild(actions);
      repliesWrap.appendChild(replyEl);
    });

    postEl.appendChild(repliesWrap);
    container.appendChild(postEl);
  });
  
  // Re-apply language if not English
  if (currentLanguage !== 'en') {
    setTimeout(() => updateDynamicTexts(currentLanguage), 100);
  }
}

function escapeHtml(str){ 
  if(!str && str !== 0) return ''; 
  return String(str).replace(/[&<>"']/g, function(s){ 
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]; 
  }); 
}
// Google Translate
function googleTranslateElementInit() {
  new google.translate.TranslateElement(
    {pageLanguage: 'en', includedLanguages: 'en,hi,ur'},
    'google_translate_element'
  );
}
</script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>