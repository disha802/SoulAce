<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SoulAce â€” GAD7 + PHQ9</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* Base inspired by booking.html: soft off-white page, card, bigger fonts */
  :root {
    --page-bg: #F5F7F2;
    --card-bg: #ffffff;
    --muted: #657A74;
    --accent: #3b82f6;
    --glass: rgba(0,0,0,0.02);
    --max-width: 1100px;
  }
  html,body{height:100%;margin:0;font-family: 'Segoe UI', Roboto, system-ui, -apple-system, Arial;}
  body{background:var(--page-bg);color:#243B36;display:flex;align-items:flex-start;justify-content:center;padding:28px 12px;}

  .container{width:100%;max-width:var(--max-width);display:grid;grid-template-columns:1fr 380px;gap:18px;}
  @media (max-width:980px){ .container{grid-template-columns:1fr} }

  .card{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:0 6px 22px rgba(30,40,40,0.06);border:1px solid rgba(0,0,0,0.03)}
  h1{margin:0 0 6px 0;font-size:22px}
  p.lead{margin:0;color:var(--muted);font-size:14px}

  /* question panel (left main) */
  .question-area { display:flex;flex-direction:column;gap:16px; }
  .q-card{background:linear-gradient(180deg, #fff, #fbfcfb);padding:18px;border-radius:12px;border:1px solid rgba(0,0,0,0.03); }
  .q-top{display:flex;justify-content:space-between;align-items:center}
  .q-title{font-size:18px;font-weight:700}
  .q-sub{color:var(--muted);font-size:13px}

  .question-text{font-size:20px;margin:12px 0 8px 0;color:#102023}

  /* options */
  .options{display:flex;gap:12px;flex-wrap:wrap}
  .option{flex:1 1 45%;min-width:160px;padding:12px 14px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;cursor:pointer;user-select:none}
  .option .lab{font-weight:700;font-size:15px}
  .option .desc{color:var(--muted);font-size:13px;margin-top:6px}
  .option.selected{outline:3px solid rgba(59,130,246,0.12);box-shadow:0 8px 18px rgba(59,130,246,0.06)}

  /* controls */
  .controls{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn.secondary{background:#f1f1f1;color:#243B36}
  .btn.primary{background:var(--accent);color:#fff}

  .progress{height:10px;background:#f0f2f1;border-radius:999px;overflow:hidden;margin-top:8px}
  .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent), #60a5fa);transition:width .25s ease}

  /* right column: summary + charts */
  .summary-col{display:flex;flex-direction:column;gap:14px}
  .score-summary{padding:14px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfcfb);border:1px solid rgba(0,0,0,0.03)}
  .score-row{display:flex;justify-content:space-between;align-items:center}
  .score-big{font-size:22px;font-weight:800}
  .sev{font-weight:700;color:#3b3b3b}
  .warn{color:#b45309;font-weight:800}

  canvas{background:transparent;border-radius:8px}

  .note{font-size:13px;color:var(--muted)}

  footer.small{margin-top:10px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<div class="container">
  <!-- LEFT: questions -->
  <main class="card question-area" role="main">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Quick Mental Health Screen</h1>
        <p class="lead">GAD-7 + PHQ-9 â€” How often in the last 2 weeks have you been bothered by these problems?</p>
      </div>
      <div style="text-align:right">
        <div class="note">Signed in as <strong id="uname">You</strong></div>
      </div>
    </div>

    <div id="questionContainer">
      <!-- JS will populate question cards (one visible at a time in vertical stack) -->
    </div>

    <div class="progress" aria-hidden="true"><i id="progressFill"></i></div>
    <div class="controls">
      <button id="backBtn" class="btn secondary">â† Back</button>
      <div style="display:flex;gap:8px">
        <button id="saveBtn" class="btn" style="display:none">Save & Exit</button>
        <button id="nextBtn" class="btn primary">Next â†’</button>
      </div>
    </div>

    <footer class="small">This is a screening tool only â€” not a diagnostic. If PHQ-9 item 9 indicates suicidal ideation, please show crisis contacts immediately.</footer>
  </main>

  <!-- RIGHT: results & charts -->
  <aside class="summary-col">
    <div class="card score-summary">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">Your Latest Scores</div>
          <div class="note">After you finish, charts will appear here.</div>
        </div>
        <div style="text-align:right">
          <div id="lastUpdate" class="note">â€”</div>
          <div style="font-size:12px;color:var(--muted)">Local</div>
        </div>
      </div>

      <div id="currentScoresArea" style="margin-top:12px;display:none">
        <div class="score-row">
          <div>
            <div class="note">Anxiety (GAD-7)</div>
            <div class="score-big" id="gadTotal">0</div>
            <div class="note" id="gadSeverity">Minimal</div>
          </div>
          <div>
            <div class="note">Depression (PHQ-9)</div>
            <div class="score-big" id="phqTotal">0</div>
            <div class="note" id="phqSeverity">None-Minimal</div>
          </div>
        </div>
        <div style="margin-top:10px">
          <button id="exportBtn" class="btn secondary">Copy results</button>
          <button id="viewHistoryBtn" class="btn primary">Refresh history</button>
        </div>
      </div>
    </div>

    <div class="card" id="chartCard" style="display:none;flex-direction:column">
      <div style="font-weight:800;margin-bottom:8px">Charts</div>
      <canvas id="barChart" height="200"></canvas>
      <div style="height:10px"></div>
      <canvas id="lineChart" height="180"></canvas>
    </div>

    <div class="card" id="safetyCard" style="display:none">
      <div style="font-weight:800;color:#b45309">Safety note</div>
      <div class="note" id="safetyText" style="margin-top:8px"></div>
    </div>

  </aside>
</div>

<script>
      // Injected by Flask (place this at the very top of your script block)
  window.__USER_ID = "{{ session.get('user_id', '') }}";
  // Use |e to escape username safely
  const __USERNAME_FROM_SERVER = "{{ session.get('username', 'You')|e }}";

  // Wait for DOM to be ready before touching elements
  document.addEventListener('DOMContentLoaded', () => {
    // set visible username
    const unameEl = document.getElementById('uname');
    if (unameEl) unameEl.textContent = __USERNAME_FROM_SERVER;

    // also expose user id (some pages use it)
    if (!window.__USER_ID) {
      // optional: fallback - keeps existing behavior
      window.__USER_ID = '';
    }
  });
  window.__USER_ID = "{{ session.get('user_id','') }}";
  document.getElementById('uname').textContent = "{{ session.get('username','You') }}";
/* QUESTIONS & OPTIONS (same mapping as before) */
const questions = [
  {id:'gad1', text:'Feeling nervous, anxious, or on edge.' , scale:'GAD'},
  {id:'gad2', text:'Not being able to stop or control worrying.' , scale:'GAD'},
  {id:'gad3', text:'Worrying too much about different things.' , scale:'GAD'},
  {id:'gad4', text:'Trouble relaxing.' , scale:'GAD'},
  {id:'gad5', text:'Being so restless that it is hard to sit still.' , scale:'GAD'},
  {id:'gad6', text:'Becoming easily annoyed or irritable.' , scale:'GAD'},
  {id:'gad7', text:'Feeling afraid as if something awful might happen.' , scale:'GAD'},
  {id:'phq1', text:'Little interest or pleasure in doing things.' , scale:'PHQ'},
  {id:'phq2', text:'Feeling down, depressed, or hopeless.' , scale:'PHQ'},
  {id:'phq3', text:'Trouble falling or staying asleep, or sleeping too much.' , scale:'PHQ'},
  {id:'phq4', text:'Feeling tired or having little energy.' , scale:'PHQ'},
  {id:'phq5', text:'Poor appetite or overeating.' , scale:'PHQ'},
  {id:'phq6', text:'Feeling bad about yourself â€” or that you are a failure or have let yourself or your family down.' , scale:'PHQ'},
  {id:'phq7', text:'Trouble concentrating on things, such as reading the newspaper or watching television.' , scale:'PHQ'},
  {id:'phq8', text:'Moving or speaking slowly OR being fidgety/restless.' , scale:'PHQ'},
  {id:'phq9', text:'Thoughts that you would be better off dead, or of hurting yourself in some way.' , scale:'PHQ'}
];

const options = [
  {label:'Not at all', score:0},
  {label:'Several days', score:1},
  {label:'More than half the days', score:2},
  {label:'Nearly every day', score:3}
];

let answers = new Array(questions.length).fill(null);
let curIndex = 0;

/* UI refs */
const qCon = document.getElementById('questionContainer');
const progressFill = document.getElementById('progressFill');
const backBtn = document.getElementById('backBtn');
const nextBtn = document.getElementById('nextBtn');
const saveBtn = document.getElementById('saveBtn');
const unameEl = document.getElementById('uname');
const currentScoresArea = document.getElementById('currentScoresArea');
const gadTotalEl = document.getElementById('gadTotal');
const phqTotalEl = document.getElementById('phqTotal');
const gadSeverityEl = document.getElementById('gadSeverity');
const phqSeverityEl = document.getElementById('phqSeverity');
const chartCard = document.getElementById('chartCard');
const chartBarCanvas = document.getElementById('barChart');
const chartLineCanvas = document.getElementById('lineChart');
const exportBtn = document.getElementById('exportBtn');
const viewHistoryBtn = document.getElementById('viewHistoryBtn');
const lastUpdate = document.getElementById('lastUpdate');
const safetyCard = document.getElementById('safetyCard');
const safetyText = document.getElementById('safetyText');

/* Generate simple stacked vertical list of question cards but only one shown at a time */
function renderQuestions(){
  qCon.innerHTML = '';
  questions.forEach((q, idx) => {
    const el = document.createElement('div');
    el.className = 'q-card';
    el.style.display = (idx === curIndex ? 'block' : 'none');
    el.dataset.index = idx;
    el.innerHTML = `
      <div class="q-top">
        <div>
          <div class="q-title">Question ${idx+1} of ${questions.length}</div>
          <div class="q-sub">${q.scale === 'GAD' ? 'GAD-7' : 'PHQ-9'}</div>
        </div>
        <div class="q-sub">${q.scale}</div>
      </div>
      <div class="question-text">${q.text}</div>
      <div class="options" aria-hidden="false"></div>
    `;
    // options
    const optsWrap = el.querySelector('.options');
    options.forEach((op, oi) => {
      const btn = document.createElement('div');
      btn.className = 'option';
      if(answers[idx] === op.score) btn.classList.add('selected');
      btn.innerHTML = `<div class="lab">${op.label}</div>`;
      btn.addEventListener('click', () => {
        answers[idx] = op.score;
        // mark selected visually
        optsWrap.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
        btn.classList.add('selected');

        // small auto-next to keep flow (except last)
        setTimeout(() => {
          if (curIndex < questions.length - 1) { curIndex++; updateView(); }
        }, 220);
      });
      optsWrap.appendChild(btn);
    });

    qCon.appendChild(el);
  });

  updateView();
}

/* update visible card & progress */
function updateView(){
  document.querySelectorAll('.q-card').forEach(card => {
    const i = Number(card.dataset.index);
    card.style.display = (i === curIndex) ? 'block' : 'none';
  });
  backBtn.disabled = curIndex === 0;
  nextBtn.textContent = (curIndex === questions.length - 1) ? 'Submit' : 'Next â†’';
  // progress percent = answered count / total
  const answered = answers.filter(x => x !== null).length;
  const percent = Math.round((answered / questions.length) * 100);
  progressFill.style.width = percent + '%';
}

/* navigation */
backBtn.addEventListener('click', () => { if(curIndex>0) curIndex--; updateView(); });
nextBtn.addEventListener('click', () => {
  if (curIndex === questions.length - 1) {
    // submit
    submitAnswers();
    return;
  }
  curIndex++; updateView();
});

exportBtn.addEventListener('click', () => {
  const payload = computePayload();
  navigator.clipboard?.writeText(JSON.stringify(payload, null, 2)).then(()=> alert('Copied to clipboard.'));
});

viewHistoryBtn.addEventListener('click', fetchHistoryAndDraw);

/* compute totals & severities */
function computePayload(){
  const gad = answers.slice(0,7).map(v => v===null?0:v);
  const phq = answers.slice(7).map(v => v===null?0:v);
  const gadTotal = gad.reduce((a,b)=>a+b,0);
  const phqTotal = phq.reduce((a,b)=>a+b,0);

  const gadSeverity = (gadTotal >= 15) ? 'Severe' : (gadTotal >= 10) ? 'Moderate' : (gadTotal >= 5) ? 'Mild' : 'Minimal';
  const phqSeverity = (phqTotal >= 20) ? 'Severe' : (phqTotal >= 15) ? 'Moderately severe' : (phqTotal >= 10) ? 'Moderate' : (phqTotal >= 5) ? 'Mild' : 'None-Minimal';

  return {
    answers, gadTotal, phqTotal, gadSeverity, phqSeverity,
    timestamp: new Date().toISOString(),
    user_id: window.__USER_ID || 'user-unknown'   // optional: set this on page if you have login
  };
}

/* POST to /api/submit, then show charts & save */
async function submitAnswers(){
  const payload = computePayload();

  // warn if no answers completed
  const answered = answers.filter(a => a !== null).length;
  if (answered < questions.length) {
    if (!confirm('You have unanswered items. Submit anyway?')) return;
  }

// safe fetch + robust JSON handling
try {
  const res = await fetch('/api/submit', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });

  // read plain text first (never throws)
  const text = await res.text();

  // try to parse JSON, otherwise show the raw text for debugging
  let body = null;
  try {
    body = text ? JSON.parse(text) : null;
  } catch (parseErr) {
    console.error('Response text (non-JSON):', text);
    // show user-friendly message + server raw text for debugging
    alert('Submission error: server returned invalid JSON.\nStatus: ' + res.status + '\nResponse: ' + (text || '[empty]'));
    return;
  }

  if (!res.ok) {
    // server sent JSON error details -> show them; otherwise show status
    const errMsg = (body && body.error) ? body.error : ('HTTP ' + res.status);
    alert('Submission error: ' + errMsg);
    return;
  }

  // success path: body should be JSON
    // success path: body should be JSON
  console.log('Server response:', body);

  // Show summary in the UI (use computed payload we sent)
  const resultPayload = payload; // computed above in submitAnswers()

  currentScoresArea.style.display = 'block';
  gadTotalEl.textContent = resultPayload.gadTotal;
  phqTotalEl.textContent = resultPayload.phqTotal;
  gadSeverityEl.textContent = resultPayload.gadSeverity;
  phqSeverityEl.textContent = resultPayload.phqSeverity;
  lastUpdate.textContent = (new Date(resultPayload.timestamp)).toLocaleString();

  // Safety note if PHQ-9 item 9 > 0
  if (answers[15] && answers[15] > 0) {
    safetyText.textContent = 'Question 9 of PHQ-9 indicates some degree of suicidal ideation. Please advise the user to contact emergency services, a crisis line, or a mental health professional immediately.';
    safetyCard.style.display = 'block';
  } else {
    safetyCard.style.display = 'none';
  }

  // fetch history and draw charts (this will also show the chartCard)
  await fetchHistoryAndDraw();

  // scroll to charts
  document.getElementById('chartCard').scrollIntoView({behavior:'smooth'});

  // continue the success flow...
} catch (networkErr) {
  alert('Network error: ' + networkErr.message);
  console.error(networkErr);
}

}

/* fetch historical records for this user and draw charts */
let barChart = null, lineChart = null;
async function fetchHistoryAndDraw(){
  // Pass user id if available
  const uidParam = window.__USER_ID ? `?user_id=${encodeURIComponent(window.__USER_ID)}` : '';
  const res = await fetch('/api/scores' + uidParam);
  if (!res.ok) {
    console.error('Failed to fetch scores');
    return;
  }
  const data = await res.json(); // expected: array of {timestamp,gadTotal,phqTotal}
  if (!Array.isArray(data)) return;

  // Build bar chart data from the latest item if exists
  const last = data.length ? data[data.length-1] : computePayload();
  const gadTotal = last?.gadTotal || 0;
  const phqTotal = last?.phqTotal || 0;

  // Show chart card
  chartCard.style.display = 'flex';

  // Bar chart: show two bars or small summary buckets (we'll show totals)
  if (barChart) barChart.destroy();
  barChart = new Chart(chartBarCanvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: ['GAD-7','PHQ-9'],
      datasets: [{
        label: 'Score total',
        data: [gadTotal, phqTotal],
        backgroundColor: ['rgba(59,130,246,0.8)','rgba(240,71,110,0.8)'],
      }]
    },
    options: {
      responsive:true,
      plugins: { legend:{display:false} },
      scales: { y:{ beginAtZero:true, suggestedMax: Math.max(15, phqTotal, gadTotal) } }
    }
  });

  // Line chart: past trend
  // Sort by timestamp asc
  const sorted = data.slice().sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));
  const labels = sorted.map(s => (new Date(s.timestamp)).toLocaleDateString());
  const gadSeries = sorted.map(s => s.gadTotal);
  const phqSeries = sorted.map(s => s.phqTotal);

  if (lineChart) lineChart.destroy();
  lineChart = new Chart(chartLineCanvas.getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'GAD-7 total', data: gadSeries, fill:false, tension:0.2, borderWidth:2, borderColor:'rgba(59,130,246,0.9)' },
        { label: 'PHQ-9 total', data: phqSeries, fill:false, tension:0.2, borderWidth:2, borderColor:'rgba(240,71,110,0.9)' }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'bottom'}}, scales:{ y:{ beginAtZero:true } } }
  });
}

/* init */
(function init(){
  renderQuestions();
  // If you have server-side username or user id, set it on the page:
  // window.__USER_ID = 'student-123'; document.getElementById('uname').textContent = 'Shreshtha';
})();
</script>

</body>
</html>