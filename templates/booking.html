<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoulAce â€” Book</title>
  <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Zain:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --page-bg: linear-gradient(135deg, #f6f3f0 20%, #e8e1dc 100%);
  --card-bg: rgba(255, 255, 255, 0.8);
  --header-bg: #eee0d1;
  --footer-bg: #eee0d1;
  --text-primary: #000000;
  --text-heading: #6b4e3d;
  --text-secondary: #8a8a8a;
  --accent-primary: #9bafd9;
  --accent-secondary: #9bafd9;
  --features-bg: #CADBD7;
  --max-width: 1100px;
  --card-border: rgba(193, 123, 107, 0.2);
  --slot-border: rgba(193, 123, 107, 0.3);
  --light-green: #f0f8f0;
  --accent-green: #9bafd9;
  --panel: var(--card-bg);
  --muted: var(--text-secondary);
  --text: var(--text-primary);
}

html, body { 
  height: 100%; 
  margin: 0; 
  font-family: 'Georgia', serif; 
  font-size: 16px;
  background: var(--page-bg);
  color: var(--text-primary);
}

  /* Booking-specific styles */

  .app {
    display: flex;
    flex-direction: row;
    min-height: 100vh;
    gap: 0;
    padding-top: 0;
  }

  .content-area {
    display: flex;
    flex: 1;
    gap: 0;
  }

  /* Left navigation (compact) */
  .nav {
    width: 220px;
    padding: 14px;
    border-right: 1px solid var(--card-border);
    background: var(--card-bg);
    backdrop-filter: blur(10px);
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo h1 {
    margin: 0;
    font-size: 1rem;
    color: var(--text-heading);
    font-family: 'Zain', sans-serif;
  }

  .nav .tab {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 700;
    color: var(--text-secondary);
    text-align: left;
    transition: all 0.3s ease;
  }

  .nav .tab:hover {
    background: var(--features-bg);
    color: var(--text-heading);
  }

  .nav .tab.active {
    background: var(--accent-primary);
    color: #fff;
  }

  /* Main content */
  .main {
    flex: 1;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 0;
  }

  /* Content grid */
  .grid {
    display: grid;
    grid-template-columns: 1fr 480px;
    gap: 12px;
    align-items: start;
    height: calc(100vh - 140px);
    min-height: 0;
  }

  .grid.booking-only {
    grid-template-columns: 1fr;
  }

  @media (max-width: 1000px) {
    .grid {
      grid-template-columns: 1fr;
    }
    .nav {
      display: none;
    }
  }

  /* Left column */
  .left {
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 0;
  }

  .card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
  }

  /* Compact calendar */
  .cal-compact {
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }

  .cal {
    width: 300px;
  }

  .cal .month {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .cal button {
    background: transparent;
    border: none;
    color: var(--accent-green);
    font-weight: 700;
    cursor: pointer;
  }

  .cal .weekday-row {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    margin-bottom: 6px;
    color: var(--muted);
    font-weight: 700;
    font-size: 0.85rem;
  }

  .cal .days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
  }

  .day {
    padding: 8px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid transparent;
    background: transparent;
    color: var(--text);
    cursor: pointer;
    font-weight: 600;
  }

  .day.out {
    opacity: 0.35;
  }

  .day.today {
    border: 1px dashed var(--slot-border);
  }

  .day.selected {
    background: var(--accent-green);
    color: #fff;
  }

  /* Slots column */
  .slots {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .slots .title {
    font-weight: 700;
    margin-bottom: 6px;
    color: var(--text);
  }

  .slots-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    overflow: auto;
    padding: 6px 0;
    max-height: 320px;
  }

  .slot {
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--slot-border);
    background: var(--features-bg);
    cursor: pointer;
    min-width: 86px;
    text-align: center;
    font-weight: 700;
    color: var(--text-heading);
    transition: all 0.3s ease;
  }

  .slot:hover {
    background: var(--accent-primary);
    color: #fff;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .slot.booked {
    background: rgba(193, 123, 107, 0.1);
    border-color: rgba(193, 123, 107, 0.3);
    color: var(--text-secondary);
    cursor: not-allowed;
    opacity: 0.6;
  }

  .slot.sel {
    background: var(--accent-primary);
    color: #fff;
    border-color: var(--accent-primary);
    box-shadow: 0 8px 20px rgba(155, 175, 217, 0.3);
    transform: translateY(-1px);
  }

  /* Right column solid light green card */
  .side-card {
    background: var(--features-bg);
    border: 1px solid var(--card-border);
    border-radius: 15px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: 100%;
    min-height: 0;
    overflow: auto;
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  .people-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .people-head div:first-child {
    color: var(--text-heading);
    font-family: 'Zain', sans-serif;
  }

  .people-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow: auto;
    padding-right: 6px;
    min-height: 0;
  }

  .person {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 12px;
    border-radius: 10px;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .person:hover {
    background: var(--features-bg);
    border-color: var(--accent-primary);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .person.sel {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: #fff;
    box-shadow: 0 4px 12px rgba(155, 175, 217, 0.3);
  }

  .avatar {
    width: 46px;
    height: 46px;
    border-radius: 10px;
    background: var(--accent-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 800;
    font-family: 'Zain', sans-serif;
  }

  .pmeta {
    font-weight: 700;
  }

  .pmeta-sub {
    color: var(--muted);
    font-size: 0.9rem;
    margin-top: 4px;
  }

  /* Bottom actions */
  .actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .btn {
    background: var(--accent-primary);
    color: #fff;
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
    font-size: 14px;
  }

  .btn:hover {
    background: var(--text-heading);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .btn.ghost {
    background: transparent;
    border: 1px solid var(--card-border);
    color: var(--text-heading);
    transition: all 0.3s ease;
  }

  .btn.ghost:hover {
    background: var(--features-bg);
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }

  /* Bookings lists */
  .bookings {
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow: auto;
  }

  .booking-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }

  .booking-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  .booking-info {
    flex: 1;
  }

  .booking-title {
    font-weight: 700;
    color: var(--text-heading);
    margin-bottom: 4px;
    font-family: 'Zain', sans-serif;
  }

  .booking-details {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 2px;
  }

  .booking-date {
    font-size: 13px;
    color: var(--accent-primary);
    font-weight: 600;
  }

  .booking-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .btn-cancel {
    background: rgba(193, 123, 107, 0.1);
    color: #c17b6b;
    border: 1px solid rgba(193, 123, 107, 0.3);
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-cancel:hover {
    background: #c17b6b;
    color: #fff;
    transform: translateY(-1px);
  }


  /* Minimal text small helper */
  .small {
    font-size: 0.92rem;
    color: var(--muted);
  }

  /* Modal */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(10, 12, 10, 0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }

  .modal {
    background: #fff;
    padding: 14px;
    border-radius: 10px;
    min-width: 320px;
    max-width: 600px;
  }

  .kbd {
    display: inline-block;
    padding: 6px 8px;
    border-radius: 6px;
    background: var(--light-green);
    font-weight: 800;
  }
</style>
</head>

<body>
  {% include 'header.html' %}
  <div class="app" role="application">
    <nav class="nav" aria-label="sections">
      <button class="tab active" id="t-book" data-target="bookView">Book</button>
      <button class="tab" id="t-upcoming" data-target="upcomingView">Upcoming</button>
      <button class="tab" id="t-past" data-target="pastView">Past</button>
    </nav>

    <main class="main">
      <!-- Upcoming & Past Bookings (moved to top) -->
      <section id="upcomingView" class="card" style="display:none;min-height:0;overflow:auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div style="font-weight:800;color:var(--text-heading);font-family:'Zain',sans-serif">Upcoming Bookings</div>
          <button id="refreshUpcoming" class="btn ghost">Refresh</button>
        </div>
        <div class="bookings" id="upcomingList">
          <div class="small">No upcoming bookings</div>
        </div>
      </section>

      <section id="pastView" class="card" style="display:none;min-height:0;overflow:auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div style="font-weight:800;color:var(--text-heading);font-family:'Zain',sans-serif">Past Bookings</div>
          <button id="refreshPast" class="btn ghost">Refresh</button>
        </div>
        <div class="bookings" id="pastList">
          <div class="small">No past bookings</div>
        </div>
      </section>

      <!-- Booking Interface -->
      <div class="grid" role="region" id="bookingGrid">
        <!-- LEFT COLUMN -->
        <section class="left" id="bookView" style="min-height:0">
          <div class="card cal-compact" style="min-height:0;overflow:hidden">
            <div class="cal">
              <div class="month">
                <button id="prev">â€¹</button>
                <div id="monthLabel"></div>
                <button id="next">â€º</button>
              </div>
              <div class="weekday-row" aria-hidden="true">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
              </div>
              <div class="days" id="daysGrid" role="grid" aria-label="Calendar"></div>
              <div style="margin-top:8px">
                <input
                  id="dateInput"
                  type="date"
                  style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--card-border)"
                />
              </div>
            </div>

            <div class="slots" style="flex:1">
              <div class="title small">Available Slots</div>
              <div class="slots-list" id="slotsGrid">
                <div class="small">Select staff to view slots</div>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
                <button id="confirmBtn" class="btn">Confirm Booking</button>
                <div class="small" id="selInfo">No selection</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div style="font-weight:700;margin-bottom:6px;color:var(--text-heading)">Notes</div>
            <textarea
              id="notes"
              placeholder="Optional note for your booking"
              style="width:100%;height:72px;padding:8px;border-radius:8px;border:1px solid var(--card-border)"
            ></textarea>
          </div>
        </section>

        <!-- RIGHT COLUMN -->
        <aside class="side-card" id="staffPanel" aria-label="staff">
          <div class="people-head">
            <div style="font-weight:800">Available Staff</div>
            <div>
              <button id="refresh" class="btn.ghost btn ghost">Refresh</button>
            </div>
          </div>

          <div style="display:flex;gap:8px;height:100%">
            <div style="flex:1">
              <div style="font-weight:700;color:var(--text-primary);margin-bottom:6px">
                Therapists
              </div>
              <div class="people-list" id="therapistsList">
                <div class="small">Loadingâ€¦</div>
              </div>
            </div>
            <div style="flex:1">
              <div style="font-weight:700;color:var(--text-primary);margin-bottom:6px">
                Proctors
              </div>
              <div class="people-list" id="proctorsList">
                <div class="small">Loadingâ€¦</div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div style="font-weight:800;margin-bottom:8px">Booked</div>
      <div style="font-weight:800;margin-bottom:8px">Kindly present this ID at the time of your booking</div>

      <div>
        <span id="mStaff"></span> â€¢ <span id="mDate"></span> <span id="mTime"></span>
      </div>
      <div style="margin-top:8px">
        ID: <span class="kbd" id="mId"></span>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="closeModal" class="btn.ghost btn">Close</button>
      </div>
    </div>
  </div>

  <script>
    /* Minimal, robust front-end behavior */
    const tabs = document.querySelectorAll('.tab');
    const views = {
      book: document.getElementById('bookView'),
      upcoming: document.getElementById('upcomingView'),
      past: document.getElementById('pastView')
    };

    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const tgt = t.dataset.target;
      document.querySelectorAll('main section.card, main section').forEach(s => s.style.display = 'none');

      const grid = document.getElementById('bookingGrid');
      
      if (tgt === 'bookView') {
        views.book.style.display = 'block';
        document.getElementById('staffPanel').style.display = 'block';
        document.getElementById('upcomingView').style.display = 'none';
        document.getElementById('pastView').style.display = 'none';
        grid.style.display = 'grid';
      } else if (tgt === 'upcomingView') {
        document.getElementById('upcomingView').style.display = 'block';
        document.getElementById('staffPanel').style.display = 'none';
        views.book.style.display = 'none';
        document.getElementById('pastView').style.display = 'none';
        grid.style.display = 'none';
        renderBookings();
      } else {
        document.getElementById('pastView').style.display = 'block';
        document.getElementById('staffPanel').style.display = 'none';
        views.book.style.display = 'none';
        document.getElementById('upcomingView').style.display = 'none';
        grid.style.display = 'none';
        renderBookings();
      }
    }));

    /* Calendar rendering (month grid with leading/trailing days) */
    const daysGrid = document.getElementById('daysGrid');
    const monthLabel = document.getElementById('monthLabel');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const dateInput = document.getElementById('dateInput');
    let calDate = new Date();
    let selectedDate = new Date();

    function startOfMonth(d) {
      return new Date(d.getFullYear(), d.getMonth(), 1);
    }

    function renderCalendar(base) {
      const year = base.getFullYear();
      const month = base.getMonth();
      monthLabel.textContent = base.toLocaleString(undefined, {
        month: 'long',
        year: 'numeric'
      });
      daysGrid.innerHTML = '';

      const first = startOfMonth(base);
      const firstWeekday = first.getDay();

      // Previous month's tail
      const prevLast = new Date(year, month, 0).getDate();
      for (let i = 0; i < firstWeekday; i++) {
        const dayNum = prevLast - firstWeekday + 1 + i;
        const div = document.createElement('div');
        div.className = 'day out';
        div.textContent = dayNum;
        daysGrid.appendChild(div);
      }

      const daysIn = new Date(year, month + 1, 0).getDate();
      for (let d = 1; d <= daysIn; d++) {
        const div = document.createElement('button');
        div.className = 'day';
        div.textContent = d;
        const cur = new Date(year, month, d);

        if (isSameDate(cur, new Date())) {
          div.classList.add('today');
        }
        if (isSameDate(cur, selectedDate)) {
          div.classList.add('selected');
        }

        div.addEventListener('click', () => {
          selectedDate = cur;
          dateInput.value = toISO(selectedDate);
          renderCalendar(calDate);
          loadSlotsForDate(toISO(selectedDate));
        });
        daysGrid.appendChild(div);
      }

      // Next month's lead to fill last row
      const totalCells = daysGrid.children.length;
      const remain = (7 - (totalCells % 7)) % 7;
      for (let i = 1; i <= remain; i++) {
        const div = document.createElement('div');
        div.className = 'day out';
        div.textContent = i;
        daysGrid.appendChild(div);
      }
    }

    function isSameDate(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function toISO(d) {
      return d.toISOString().split('T')[0];
    }

    prevBtn.addEventListener('click', () => {
      calDate.setMonth(calDate.getMonth() - 1);
      renderCalendar(calDate);
    });

    nextBtn.addEventListener('click', () => {
      calDate.setMonth(calDate.getMonth() + 1);
      renderCalendar(calDate);
    });

    dateInput.addEventListener('change', () => {
      if (dateInput.value) {
        selectedDate = new Date(dateInput.value + 'T00:00:00');
        calDate = new Date(selectedDate);
        renderCalendar(calDate);
        loadSlotsForDate(dateInput.value);
      }
    });

    renderCalendar(calDate);
    dateInput.value = toISO(selectedDate);

    /* Staff lists and slots (demo fallback) */
    const therapistsList = document.getElementById('therapistsList');
    const proctorsList = document.getElementById('proctorsList');
    const slotsGrid = document.getElementById('slotsGrid');
    const selInfo = document.getElementById('selInfo');
    const confirmBtn = document.getElementById('confirmBtn');
    let therapists = [];
    let proctors = [];
    let selectedStaff = null;
    let selectedSlot = null;
    let bookings = [];

    /* Demo fetch fallback */
    function fetchData(path) {
      return fetch(path)
        .then(r => r.ok ? r.json() : Promise.reject())
        .catch(() => demo(path));
    }

    function demo(path) {
      if (path === '/api/therapists') {
        return Promise.resolve([
          { _id: 't1', name: 'Dr. Asha Mehra', expertise: 'CBT', years: 8, location: 'Mumbai' },
          { _id: 't2', name: 'Dr. Kavita Rao', expertise: 'Depression', years: 10, location: 'Bengaluru' },
          { _id: 't3', name: 'Rohit Sharma', expertise: 'Career', years: 5, location: 'Delhi' }
        ]);
      }

      if (path === '/api/proctors') {
        return Promise.resolve([
          { _id: 'p1', name: 'Ramesh Kumar', expertise: 'Exams', years: 11, location: 'Kolkata' },
          { _id: 'p2', name: 'Priya Singh', expertise: 'Online proctoring', years: 6, location: 'Delhi' }
        ]);
      }

      if (path.includes('/slots')) {
        const q = new URLSearchParams(path.split('?')[1] || '');
        const date = q.get('date') || toISO(selectedDate);
        const times = ['09:00', '09:30', '10:00', '11:30', '14:00', '14:30', '15:00', '16:00'];
        return Promise.resolve({
          slots: times.map(t => ({
            _id: 's' + Math.random().toString(36).slice(2, 8),
            date,
            time: t,
            status: Math.random() < 0.12 ? 'booked' : 'free'
          }))
        });
      }

      if (path.startsWith('/api/book')) {
        const id = 'BK' + Math.random().toString(36).slice(2, 7).toUpperCase();
        return Promise.resolve({ booking_id: id });
      }

      if (path.startsWith('/api/bookings')) {
        return Promise.resolve(bookings);
      }

      return Promise.resolve([]);
    }

    /* Render staff */
    async function loadStaff() {
      therapistsList.innerHTML = '<div class="small">Loadingâ€¦</div>';
      proctorsList.innerHTML = '<div class="small">Loadingâ€¦</div>';

      therapists = await fetchData('/api/therapists');
      proctors = await fetchData('/api/proctors');

      therapistsList.innerHTML = '';
      proctorsList.innerHTML = '';

      therapists.forEach(t => therapistsList.appendChild(personNode(t, 'therapist')));
      proctors.forEach(p => proctorsList.appendChild(personNode(p, 'proctor')));
    }

    function personNode(p, kind) {
      const wrapper = document.createElement('div');
      wrapper.className = 'person';
      wrapper.dataset.id = p._id;
      wrapper.dataset.kind = kind;

      wrapper.innerHTML = `
        <div class="avatar">
          ${(p.name || 'P').split(' ').map(s => s[0]).slice(0, 2).join('')}
        </div>
        <div style="flex:1">
          <div class="pmeta">${p.name}</div>
          <div class="pmeta-sub">${p.expertise} Â· ${p.years || p.years_experience || ''} yrs</div>
        </div>
      `;

      wrapper.addEventListener('click', () => {
        document.querySelectorAll('.person').forEach(x => x.classList.remove('sel'));
        wrapper.classList.add('sel');
        selectedStaff = { kind, obj: p };
        selInfo.textContent = `${p.name}`;
        loadSlotsForDate(toISO(selectedDate));
      });

      return wrapper;
    }

    /* Slots loader */
    async function loadSlotsForDate(date) {
      slotsGrid.innerHTML = '<div class="small">Loading slotsâ€¦</div>';

      if (!selectedStaff) {
        slotsGrid.innerHTML = '<div class="small">Select staff</div>';
        return;
      }

      const kindPath = selectedStaff.kind === 'therapist' ? 'therapists' : 'proctors';
      const res = await fetchData(`/api/${kindPath}/${encodeURIComponent(selectedStaff.obj._id)}/slots?date=${encodeURIComponent(date)}`);
      const slots = res.slots || [];

      slotsGrid.innerHTML = '';

      if (!slots.length) {
        slotsGrid.innerHTML = '<div class="small">No slots</div>';
        return;
      }

      slots.forEach(s => {
        const el = document.createElement('button');
        el.className = 'slot' + (s.status === 'booked' ? ' booked' : '');
        el.textContent = s.time;
        el.dataset.id = s._id;
        el.dataset.time = s.time;
        el.dataset.date = s.date;

        if (s.status !== 'booked') {
          el.addEventListener('click', () => {
            document.querySelectorAll('.slot.sel').forEach(x => x.classList.remove('sel'));
            el.classList.add('sel');
            selectedSlot = s;
            selInfo.textContent = `${selectedStaff.obj.name} â€¢ ${s.date} ${s.time}`;
          });
        }

        slotsGrid.appendChild(el);
      });
    }

    /* Confirm booking */
    confirmBtn.addEventListener('click', async () => {
      if (!selectedStaff) return alert('Select staff');
      if (!selectedSlot) return alert('Select slot');

      // Check if user already has a booking for this date
      const existingBooking = bookings.find(b => b.date === selectedSlot.date);
      if (existingBooking) {
        alert(`You already have a booking on ${selectedSlot.date}. Only one booking per day is allowed.`);
        return;
      }

      const payload = {
        date: selectedSlot.date,
        time: selectedSlot.time,
        slot_id: selectedSlot._id
      };

      if (selectedStaff.kind === 'therapist') {
        payload.therapist_id = selectedStaff.obj._id;
      } else {
        payload.proctor_id = selectedStaff.obj._id;
      }

      payload.concerns = document.getElementById('notes').value || '';

      // Optimistic UI: mark slot
      document.querySelectorAll('.slot.sel').forEach(s => {
        s.classList.remove('sel');
        s.classList.add('booked');
      });

      const res = await fetch('/api/book', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(r => r.ok ? r.json() : demo('/api/book'));

      const id = res.booking_id || res.bookingId || ('BK' + Math.random().toString(36).slice(2, 8).toUpperCase());

      bookings.push({
        id,
        date: payload.date,
        time: payload.time,
        staff: selectedStaff.obj.name,
        role: selectedStaff.kind,
        note: payload.concerns
      });

      showModal({
        id,
        staff: selectedStaff.obj.name,
        date: payload.date,
        time: payload.time
      });

      renderBookings();
    });

    /* Refresh buttons */
    document.getElementById('refreshUpcoming')?.addEventListener('click', () => {
      renderBookings();
    });

    document.getElementById('refreshPast')?.addEventListener('click', () => {
      renderBookings();
    });

    /* Bookings */
    function renderBookings() {
      const up = document.getElementById('upcomingList');
      const past = document.getElementById('pastList');
      up.innerHTML = '';
      past.innerHTML = '';

      const now = new Date();

      bookings.forEach(b => {
        const dt = new Date(`${b.date}T${b.time}:00`);
        const el = document.createElement('div');
        el.className = 'booking-item';
        
        if (dt >= now) {
          // Upcoming booking with cancel button
          el.innerHTML = `
            <div class="booking-info">
              <div class="booking-title">${b.staff}</div>
              <div class="booking-details">${b.role}</div>
              <div class="booking-date">${b.date} at ${b.time}</div>
            </div>
            <div class="booking-actions">
              <button class="btn-cancel" onclick="cancelBooking('${b.id || b.date + '_' + b.time}')">Cancel</button>
            </div>
          `;
          up.appendChild(el);
        } else {
          // Past booking
          el.innerHTML = `
            <div class="booking-info">
              <div class="booking-title">${b.staff}</div>
              <div class="booking-details">${b.role}</div>
              <div class="booking-date">${b.date} at ${b.time}</div>
            </div>
            <div class="booking-actions">
              <span class="small" style="color: var(--text-secondary);">Completed</span>
            </div>
          `;
          past.appendChild(el);
        }
      });

      if (!up.children.length) {
        up.innerHTML = '<div class="small">No upcoming bookings</div>';
      }
      if (!past.children.length) {
        past.innerHTML = '<div class="small">No past bookings</div>';
      }
    }

    /* Cancel booking */
    async function cancelBooking(bookingId) {
      if (!confirm('Are you sure you want to cancel this booking?')) {
        return;
      }

      try {
        // Remove from local bookings array
        const bookingIndex = bookings.findIndex(b => (b.id || b.date + '_' + b.time) === bookingId);
        if (bookingIndex !== -1) {
          bookings.splice(bookingIndex, 1);
        }

        // Refresh the display
        renderBookings();
        
        // Show success message
        alert('Booking cancelled successfully');
        
        // In a real app, you would also send a request to the server
        // await fetch('/api/cancel_booking', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify({ booking_id: bookingId })
        // });
      } catch (err) {
        console.error('Cancel booking error:', err);
        alert('Error cancelling booking');
      }
    }

    /* Modal */
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('closeModal');

    function showModal(obj) {
      document.getElementById('mStaff').textContent = obj.staff;
      document.getElementById('mDate').textContent = obj.date;
      document.getElementById('mTime').textContent = obj.time;
      document.getElementById('mId').textContent = obj.id;
      modal.style.display = 'flex';
    }

    closeModal.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    /* Initialize */
    loadStaff();
    renderCalendar(calDate);

    document.getElementById('refresh').addEventListener('click', () => {
      loadStaff();
    });
  </script>
</body>
</html>