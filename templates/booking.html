<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SoulAce — Therapist-first Booking (UID required)</title>
<style>
  /* --- overall --- */
  body{margin:0;font-family:'Segoe UI',sans-serif;background:#F5F7F2;color:#333}
  .container{max-width:1100px;margin:2rem auto;padding:0 1rem}
  .columns{display:grid;grid-template-columns:1fr 380px;gap:1.5rem;align-items:start}
  @media (max-width:980px){.columns{grid-template-columns:1fr}.therapist-panel{order:2}}

  /* booking card */
  .card{background:#fff;padding:1.8rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  .hero-row{display:flex;gap:1.25rem;align-items:center}
  h2{margin:0 0 0.5rem 0;color:#243B36}
  p.lead{margin:0;color:#657A74}

  /* form */
  .form-group{margin-top:1rem}
  .form-input,.form-select,.form-textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;box-sizing:border-box}
  .form-textarea{min-height:100px;resize:vertical}
  .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(135deg,#657A74,#243B36);color:#fff;cursor:pointer}
  .small{font-size:0.85rem;color:#657A74}
  .error{color:#b00020;font-size:0.9rem;margin-top:6px;display:none}

  /* therapist panel */
  .therapist-panel .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem}
  .therapist-list{display:grid;gap:0.75rem;max-height:520px;overflow:auto}
  .therapist-card{display:flex;gap:0.75rem;align-items:center;padding:10px;border-radius:10px;border:1px solid #e6e6e6;cursor:pointer;background:#fff;transition:transform .15s,box-shadow .15s}
  .therapist-card:hover{transform:translateY(-4px);box-shadow:0 6px 14px rgba(0,0,0,0.06)}
  .therapist-card.selected{border-color:#7B9B8B;background:rgba(123,155,139,0.06)}
  .therapist-avatar{width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;background:linear-gradient(135deg,#7B9B8B,#243B36)}
  .meta-small{color:#657A74;font-size:0.9rem}

  /* slots */
  .slots-panel{margin-top:1rem;background:#fff;padding:12px;border-radius:10px;border:1px solid #e9e9e9}
  .slots-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .slot{padding:8px 10px;border-radius:8px;border:1px solid #ddd;min-width:90px;text-align:center;cursor:pointer}
  .slot.booked{background:#f8d7da;border-color:#f5c2c7;color:#6b0f0f}           /* red - already booked */
  .slot.available{background:#fff;border-color:#ddd;color:inherit}            /* white - available */
  .slot.mine{background:#d4edda;border-color:#c3e6cb;color:#145214}            /* green - you have booked */
  .slot.disabled{opacity:.6;cursor:not-allowed}
  .slot.selected-slot{outline:3px solid rgba(37,150,120,0.12);box-shadow:0 8px 20px rgba(37,150,120,0.06)}

  .empty{padding:12px;border-radius:8px;background:#fff;border:1px dashed #e3e3e3;text-align:center;color:#999}
</style>
</head>
<body>
  <!-- header: keep your app header & user controls (not repeated here) -->
  <div class="container">
    <div class="columns">
      <!-- LEFT: Booking card (illustration removed, UID field added) -->
      <div class="card">
        <div class="hero-row">
          <div style="flex:1">
            <h2>Hello {{ username }}, Book your session</h2>
            <p class="lead">Choose a therapist on the right, pick a date, and select an available slot. Provide your 10-digit UID to complete booking.</p>
          </div>
        </div>

        <form id="bookingForm" style="margin-top:1.25rem" novalidate>
          <div class="form-group">
            <label for="studentUid">Student UID (10 digits) <span style="color:#b00020">*</span></label>
            <input id="studentUid" name="studentUid" class="form-input" type="text" inputmode="numeric" pattern="^\d{10}$" maxlength="10" placeholder="e.g. 0123456789" required>
            <div id="uidError" class="error">Please enter a valid 10-digit UID.</div>
          </div>

          <div class="form-group">
            <label for="concerns">Areas of Concern (optional)</label>
            <textarea id="concerns" class="form-textarea" placeholder="Briefly describe what you'd like to discuss"></textarea>
          </div>

          <div class="form-group" style="margin-top:0.75rem">
            <label class="small"><input type="checkbox" id="agreement" required> I understand this is confidential and agree to terms.</label>
          </div>

          <div style="margin-top:1rem">
            <button class="btn" id="bookBtn" type="submit">Book Selected Slot</button>
          </div>
        </form>
      </div>

      <!-- RIGHT: therapist-first panel -->
      <aside class="therapist-panel">
        <div class="card">
          <div class="header">
            <strong>Choose Therapist</strong>
            <button class="btn" id="refreshTherapists">Refresh</button>
          </div>

          <div id="therapistList" class="therapist-list">
            <div class="empty">Loading therapists…</div>
          </div>

          <div id="slotsPanel" class="slots-panel" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong id="slotsTherapistName"></strong>
                <div class="meta-small" id="slotsTherapistMeta"></div>
              </div>
              <div class="small">Date: <input id="slotsDate" type="date" class="form-input" style="width:auto;display:inline-block"></div>
            </div>

            <div id="slotsGrid" class="slots-grid"></div>

            <div style="margin-top:10px" class="small">
              Legend: <span style="background:#fff;border:1px solid #ddd;padding:3px 6px;border-radius:6px">Available</span>
              <span style="background:#f8d7da;border:1px solid #f5c2c7;padding:3px 6px;border-radius:6px;margin-left:6px">Booked</span>
              <span style="background:#d4edda;border:1px solid #c3e6cb;padding:3px 6px;border-radius:6px;margin-left:6px">Your booking</span>
            </div>
          </div>

        </div>
      </aside>
    </div>
  </div>

<script>
/* Therapist-first booking flow with required 10-digit UID field.
   Server must accept `student_uid` in /api/book payload for verification.
*/

const currentUser = {
  id: "{{ current_user_id|default('student-123') }}",
  name: "{{ username|default('Student') }}"
};

const therapistListEl = document.getElementById('therapistList');
const slotsPanel = document.getElementById('slotsPanel');
const slotsGrid = document.getElementById('slotsGrid');
const slotsTherapistName = document.getElementById('slotsTherapistName');
const slotsTherapistMeta = document.getElementById('slotsTherapistMeta');
const slotsDateInput = document.getElementById('slotsDate');

let therapists = [];
let selectedTherapist = null;
let selectedSlot = null;

document.addEventListener('DOMContentLoaded', () => {
  const today = new Date().toISOString().split('T')[0];
  slotsDateInput.min = today;
  slotsDateInput.value = today;

  fetchTherapists();
  document.getElementById('refreshTherapists').addEventListener('click', fetchTherapists);

  slotsDateInput.addEventListener('change', ()=>{
    if (selectedTherapist) loadSlotsFor(selectedTherapist._id, slotsDateInput.value);
  });

  // Booking form submit
  document.getElementById('bookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // UID validation
    const uidInput = document.getElementById('studentUid');
    const uidErr = document.getElementById('uidError');
    const uidVal = (uidInput.value || '').trim();
    const uidPattern = /^\d{10}$/;
    if (!uidPattern.test(uidVal)) {
      uidErr.style.display = 'block';
      uidInput.focus();
      return;
    } else {
      uidErr.style.display = 'none';
    }

    if (!selectedTherapist || !selectedSlot) {
      alert('Please select a therapist and an available slot first.');
      return;
    }
    if (!document.getElementById('agreement').checked) {
      alert('Please accept terms.');
      return;
    }

    const concerns = document.getElementById('concerns').value || '';

    try {
      const res = await fetch('/api/book', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          therapist_id: selectedTherapist._id,
          slot_id: selectedSlot._id,
          date: selectedSlot.date,
          time: selectedSlot.time,
          user_id: currentUser.id,
          student_uid: uidVal,
          concerns
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || 'Booking failed');
      alert('Booking confirmed!');
      // mark local slot as mine and refresh slots UI
      markSlotAsBookedLocally(selectedSlot._id, true);
      selectedSlot = null;
      // optionally clear UID? we keep it filled so subsequent bookings are fast
    } catch(err){
      alert('Booking error: ' + err.message);
      if (selectedTherapist) loadSlotsFor(selectedTherapist._id, slotsDateInput.value);
    }
  });
});

async function fetchTherapists(){
  therapistListEl.innerHTML = '<div class="empty">Loading therapists…</div>';
  try {
    const res = await fetch('/api/therapists');
    if (!res.ok) throw new Error('Failed');
    therapists = await res.json();
    renderTherapists();
  } catch(err){
    therapistListEl.innerHTML = '<div class="empty">Could not load therapists.</div>';
    console.error(err);
  }
}

function renderTherapists(){
  if (!therapists || therapists.length === 0) { therapistListEl.innerHTML = '<div class="empty">No therapists.</div>'; return; }
  therapistListEl.innerHTML = '';
  therapists.forEach(t=>{
    const card = document.createElement('div');
    card.className = 'therapist-card';
    card.dataset.id = t._id;
    card.innerHTML = `<div class="therapist-avatar">${(t.name||'T').split(' ').map(s=>s[0]).slice(0,2).join('')}</div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${escapeHtml(t.name)}</strong><div class="meta-small">${escapeHtml(t.expertise||'—')}</div></div>
          <div class="small">${t.years_experience||0} yrs</div>
        </div>
        <div class="meta-small">${escapeHtml(t.location||'—')}</div>
      </div>`;
    card.addEventListener('click', ()=>selectTherapistCard(t, card));
    therapistListEl.appendChild(card);
  });
}

function selectTherapistCard(t, el){
  document.querySelectorAll('.therapist-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  selectedTherapist = t;
  selectedSlot = null;
  slotsPanel.style.display = 'block';
  slotsTherapistName.textContent = t.name;
  slotsTherapistMeta.textContent = `${t.expertise || '—'} · ${t.years_experience || 0} yrs · ${t.location || '—'}`;
  loadSlotsFor(t._id, slotsDateInput.value);
}

async function loadSlotsFor(therapistId, date){
  slotsGrid.innerHTML = '<div class="empty">Loading slots…</div>';
  try {
    const res = await fetch(`/api/therapists/${encodeURIComponent(therapistId)}/slots?date=${encodeURIComponent(date)}`);
    if (!res.ok) throw new Error('Failed');
    const body = await res.json();
    renderSlotsGrid(body.slots || []);
  } catch(err){
    slotsGrid.innerHTML = '<div class="empty">Could not load slots.</div>';
    console.error(err);
  }
}

function renderSlotsGrid(slots){
  slotsGrid.innerHTML = '';
  if (!slots || slots.length === 0) { slotsGrid.innerHTML = '<div class="empty">No slots.</div>'; return; }

  slots.forEach(s=>{
    const div = document.createElement('div');
    div.className = 'slot';
    div.dataset.slotId = s._id;
    div.dataset.time = s.time;
    div.textContent = s.time;

    if (s.status === 'booked') {
      if (s.booked_by && s.booked_by === currentUser.id) {
        div.classList.add('mine');
      } else {
        div.classList.add('booked','disabled');
      }
    } else {
      div.classList.add('available');
      div.addEventListener('click', ()=> {
        // select this slot (highlight) — booking occurs when user submits form
        // clear other selected visuals
        Array.from(slotsGrid.children).forEach(c=>{
          c.classList.remove('selected-slot');
          c.style.boxShadow = '';
        });
        div.classList.add('selected-slot');
        div.style.boxShadow = '0 6px 14px rgba(37,150,120,0.08)';
        // store selected slot with full info
        selectedSlot = { _id: s._id, time: s.time, date: s.date };
      });
    }
    slotsGrid.appendChild(div);
  });
}

function markSlotAsBookedLocally(slotId, isMine){
  const el = slotsGrid.querySelector(`[data-slot-id="${slotId}"]`);
  if (!el) return loadSlotsFor(selectedTherapist._id, slotsDateInput.value);
  el.classList.remove('available','booked','mine','disabled','selected-slot');
  el.style.boxShadow = '';
  if (isMine) { el.classList.add('mine'); el.classList.add('disabled'); el.textContent = el.dataset.time; }
  else { el.classList.add('booked'); el.classList.add('disabled'); }
}

function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
</script>
</body>
</html>
