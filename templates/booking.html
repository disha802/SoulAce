<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SoulAce ‚Äî Therapist & Proctor booking</title>
<style>
  body { margin:0; font-family:'Segoe UI', sans-serif; background:#F5F7F2; color:#333; transition:0.4s; }
    header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background-color:#7B9B8B; }
    .header-left { display:flex; align-items:center; gap:15px; }
    .header-text { display:flex; flex-direction:column; }
    .logo-container img { width:60px; height:60px; border-radius:50%; object-fit:cover; }
    header h1 { margin:0; font-size:1.8rem; color:#fff; }
    .header-text h3 { margin:0; font-size:1rem; font-weight:normal; color:#FFF7E4; }
    .header-right { display:flex; align-items:center; gap:10px; position:relative; }
    .user-icon { width:40px; height:40px; border-radius:50%; cursor:pointer; }
    .user-popup { display:none; position:absolute; top:50px; right:0; background:#fff; border-radius:12px; padding:10px; min-width:160px; box-shadow:0 5px 15px rgba(0,0,0,0.2); }
    .popup-btn { display:block; width:100%; margin-bottom:8px; background:#fff; color:#243B36; font-weight:600; padding: 5px; border:none; border-radius:8px; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.2); text-align:left; }
    .popup-btn:hover { background:#f2f2f2; }
    a {text-decoration: none;}
  #google_translate_element {
  margin-top:8px;
}
  footer { text-align:center; padding:1rem; font-size:0.9rem; background:#ffeecf; border-top:2px solid #fcd58d; margin-top:2rem; }

  /* --- overall --- */
  body{margin:0;font-family:'Segoe UI',sans-serif;background:#F5F7F2;color:#333}
  .container{max-width:1300px;margin:2rem auto;padding:0 1rem}
  /* three columns: main + therapist + proctor */
  .columns{display:grid;grid-template-columns:1fr 360px 360px;gap:1.5rem;align-items:start}
  @media (max-width:1200px){.columns{grid-template-columns:1fr 360px;}}
  @media (max-width:980px){.columns{grid-template-columns:1fr}.therapist-panel{order:2}.proctor-panel{order:3}}

  /* booking card */
  .card{background:#fff;padding:1.8rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  .hero-row{display:flex;gap:1.25rem;align-items:center}
  h2{margin:0 0 0.5rem 0;color:#243B36}
  p.lead{margin:0;color:#657A74}

  /* form */
  .form-group{margin-top:1rem}
  .form-input,.form-select,.form-textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;box-sizing:border-box}
  .form-textarea{min-height:100px;resize:vertical}
  .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(135deg,#657A74,#243B36);color:#fff;cursor:pointer}
  .small{font-size:0.85rem;color:#657A74}
  .error{color:#b00020;font-size:0.9rem;margin-top:6px;display:none}

  /* tiny layout tweaks for bookings lists */
  .bookings { margin-top:1.25rem; display:grid; gap:0.75rem; }
  .booking-item { padding:10px; border-radius:8px; background:#fff; border:1px solid #eee; display:flex; justify-content:space-between; gap:10px; align-items:center; }
  .booking-left { display:flex; gap:10px; align-items:center; }
  .pill { padding:4px 8px; border-radius:999px; font-size:0.85rem; background:#f1f1f1; color:#333; }

  /* therapist/proctor panel */
  .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem}
  .list{display:grid;gap:0.75rem;max-height:480px;overflow:auto}
  .person-card{display:flex;gap:0.75rem;align-items:center;padding:10px;border-radius:10px;border:1px solid #e6e6e6;cursor:pointer;background:#fff;transition:transform .15s,box-shadow .15s}
  .person-card:hover{transform:translateY(-4px);box-shadow:0 6px 14px rgba(0,0,0,0.06)}
  .person-card.selected{border-color:#7B9B8B;background:rgba(123,155,139,0.06)}
  .avatar{width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;background:linear-gradient(135deg,#7B9B8B,#243B36)}
  .meta-small{color:#657A74;font-size:0.9rem}

  /* slots */
  .slots-panel{margin-top:1rem;background:#fff;padding:12px;border-radius:10px;border:1px solid #e9e9e9}
  .slots-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .slot{padding:8px 10px;border-radius:8px;border:1px solid #ddd;min-width:90px;text-align:center;cursor:pointer}
  .slot.booked{background:#f8d7da;border-color:#f5c2c7;color:#6b0f0f}           /* red - already booked */
  .slot.available{background:#fff;border-color:#ddd;color:inherit}            /* white - available */
  .slot.mine{background:#d4edda;border-color:#c3e6cb;color:#145214}            /* green - you have booked */
  .slot.disabled{opacity:.6;cursor:not-allowed}
  .slot.selected-slot{outline:3px solid rgba(37,150,120,0.12);box-shadow:0 8px 20px rgba(37,150,120,0.06)}

  .empty{padding:12px;border-radius:8px;background:#fff;border:1px dashed #e3e3e3;text-align:center;color:#999}
  .back-btn {
  display: inline-block;
  font-size: 0.9rem;
  color: #243B36;
  background: #f1f1f1;
  padding: 6px 12px;
  border-radius: 6px;
  text-decoration: none;
  margin-bottom: 12px;
  transition: background 0.2s, transform 0.2s;
}
.back-btn:hover {
  background: #e0e0e0;
  transform: translateY(-1px);
}
/* Dark Mode Styles - Add this to your existing <style> section */

/* Dark mode root variables for easy color management */
body.dark-mode {
  --bg-primary: #1a1a1a;
  --bg-secondary: #2d2d2d;
  --bg-card: #333333;
  --text-primary: #ffffff;
  --text-secondary: #b0b0b0;
  --text-muted: #888888;
  --border-color: #444444;
  --accent-color: #7B9B8B;
  --hover-bg: #404040;
}

/* Main background and text colors */
body.dark-mode {
  background: var(--bg-primary);
  color: var(--text-primary);
}

/* Header adjustments */
body.dark-mode header {
  background-color: #2a4a3a;
}

body.dark-mode .header-text h3 {
  color: #e6d7b8;
}

/* Cards and panels */
body.dark-mode .card {
  background: var(--bg-card);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* Form elements */
body.dark-mode .form-input,
body.dark-mode .form-select,
body.dark-mode .form-textarea {
  background: var(--bg-secondary);
  border-color: var(--border-color);
  color: var(--text-primary);
}

body.dark-mode .form-input::placeholder,
body.dark-mode .form-textarea::placeholder {
  color: var(--text-muted);
}

/* Person cards */
body.dark-mode .person-card {
  background: var(--bg-secondary);
  border-color: var(--border-color);
}

body.dark-mode .person-card:hover {
  background: var(--hover-bg);
  box-shadow: 0 6px 14px rgba(0,0,0,0.4);
}

body.dark-mode .person-card.selected {
  border-color: var(--accent-color);
  background: rgba(123,155,139,0.15);
}

/* Slots panel and slots */
body.dark-mode .slots-panel {
  background: var(--bg-secondary);
  border-color: var(--border-color);
}

body.dark-mode .slot.available {
  background: var(--bg-secondary);
  border-color: var(--border-color);
  color: var(--text-primary);
}

body.dark-mode .slot.booked {
  background: #4a2c2c;
  border-color: #6b3636;
  color: #ff9999;
}

body.dark-mode .slot.mine {
  background: #2c4a2c;
  border-color: #366b36;
  color: #99ff99;
}

/* Booking items */
body.dark-mode .booking-item {
  background: var(--bg-secondary);
  border-color: var(--border-color);
}

/* Meta text and small text */
body.dark-mode .meta-small,
body.dark-mode .small {
  color: var(--text-muted);
}

/* Pills */
body.dark-mode .pill {
  background: var(--bg-secondary);
  color: var(--text-secondary);
}

/* Empty states */
body.dark-mode .empty {
  background: var(--bg-secondary);
  border-color: var(--border-color);
  color: var(--text-muted);
}

/* User popup */
body.dark-mode .user-popup {
  background: var(--bg-card);
  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  color: var(--text-primary);
}

body.dark-mode .user-popup .popup-btn:hover {
  background: var(--hover-bg);
}

/* Back button */
body.dark-mode .back-btn {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

body.dark-mode .back-btn:hover {
  background: var(--hover-bg);
}

/* Footer */
body.dark-mode footer {
  background: #2a2a2a;
  border-top-color: #444;
  color: var(--text-secondary);
}

/* Error messages */
body.dark-mode .error {
  color: #ff6b6b;
}

/* Headings */
body.dark-mode h2,
body.dark-mode h3 {
  color: var(--text-primary);
}

/* Lead text */
body.dark-mode p.lead {
  color: var(--text-secondary);
}

/* Avatar in booking items - dark mode variant */
body.dark-mode .booking-item .avatar {
  background: #2a4a2a !important;
  color: #7B9B8B !important;
}

/* Transition for smooth mode switching */
body {
  transition: background-color 0.3s ease, color 0.3s ease;
}

.card, .person-card, .form-input, .form-select, .form-textarea, .slot, .booking-item, .user-popup {
  transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
}
</style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="logo-container">
        <img src="{{ url_for('static', filename='header-logo.png') }}" alt="SoulAce Logo">
      </div>
      <div class="header-text">
        <h1  >SoulAce</h1>
        <h3 >Wellness begins here</h3>
      </div>
    </div>
    <div class="header-right">
      <div class="user-icon-container">
        <img src="{{ url_for('static', filename='user-icon.jpeg') }}" alt="User Icon" class="user-icon" onclick="toggleUserPopup()">
        <div id="user-popup" class="user-popup">
          <!-- Google Translate -->
          <div id="google_translate_element" style="margin-bottom:10px;"></div>
          <div style="margin-bottom:10px;">
          </div>
          <a href="{{ url_for('dashboard') }}" class="popup-btn" >üè† Home</a>
          <button onclick="toggleMode()" class="popup-btn">üåô Change Mode</button>
          <form action="{{ url_for('logout') }}" method="POST" style="margin:0;">
            <button type="submit" class="popup-btn">üö™ Logout</button>
          </form>
        </div>
      </div>
    </div>
  </header>


  <div class="container">
    <div class="columns">
      <!-- MAIN: Booking card + bookings lists -->
      <div class="card">
        <a href="{{ url_for('dashboard') }}" class="back-btn">‚Üê Back</a>
        <div class="hero-row">
          <div style="flex:1">
          <h2 
  Hello {{ username }}, Book your session
</h2>
            <p class="lead" 
  Select a Therapist or Proctor on the right, pick date & slot, then provide your 10-digit UID to confirm.</p>
          </div>
        </div>

        <form id="bookingForm" style="margin-top:1.25rem" novalidate>
          <div class="form-group">
            <label for="studentUid">Student UID (10 digits) <span style="color:#b00020">*</span></label>
            <input id="studentUid" name="studentUid" class="form-input" type="text" inputmode="numeric" pattern="^\d{10}$" maxlength="10" placeholder="e.g. 0123456789" required>
            <div id="uidError" class="error">Please enter a valid 10-digit UID.</div>
          </div>

          <div class="form-group">
            <label for="concerns">Areas of Concern (optional)</label>
            <textarea id="concerns" class="form-textarea" placeholder="Briefly describe what you'd like to discuss"></textarea>
          </div>

          <div class="form-group" style="margin-top:0.75rem">
            <label class="small"><input type="checkbox" id="agreement" required> I understand this is confidential and agree to terms.</label>
          </div>

          <div style="margin-top:1rem">
            <button class="btn" id="bookBtn" type="submit">Book Selected Slot</button>
          </div>
        </form>

        <!-- bookings lists -->
        <div class="bookings" id="bookingsContainer">
          <h3 style="margin-top:1.25rem;margin-bottom:8px;color:#243B36">Upcoming Bookings</h3>
          <div id="upcomingList" class="list">
            <div class="empty">Loading upcoming bookings‚Ä¶</div>
          </div>

          <h3 style="margin-top:1rem;margin-bottom:8px;color:#243B36">Past Bookings</h3>
          <div id="pastList" class="list">
            <div class="empty">Loading past bookings‚Ä¶</div>
          </div>
        </div>
      </div>

      <!-- RIGHT-1: Therapist -->
      <aside class="therapist-panel">
  <div class="card">
    <div class="panel-header">
      <strong>
        Choose Therapist
      </strong>
      <button class="btn" id="refreshTherapists">
        Refresh
      </button>
    </div>
  </div>
</aside>
      <!-- RIGHT-2: Proctor -->
     <aside class="proctor-panel">
  <div class="card">
    <div class="panel-header">
      <strong>
        Choose Proctor
      </strong>
      <button>
        Refresh
      </button>
    </div>

    <div id="proctorList" class="list">
      <div class="empty">
        Loading proctors‚Ä¶
      </div>
    </div>

    <div id="proctorSlotsPanel" class="slots-panel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong id="pSlotsName"></strong>
          <div class="meta-small" id="pSlotsMeta"></div>
        </div>
        <div class="small">
          Date:
          <input id="pSlotsDate" type="date" class="form-input" style="width:auto;display:inline-block">
        </div>
      </div>
      <div id="pSlotsGrid" class="slots-grid"></div>
    </div>
  </div>
</aside>


          <div id="therapistList" class="list">
            <div class="empty">Loading therapists‚Ä¶</div>
          </div>

          <div id="therapistSlotsPanel" class="slots-panel" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong id="tSlotsName"></strong>
                <div class="meta-small" id="tSlotsMeta"></div>
              </div>
              <div class="small">Date: <input id="tSlotsDate" type="date" class="form-input" style="width:auto;display:inline-block"></div>
            </div>
            <div id="tSlotsGrid" class="slots-grid"></div>
          </div>
        </div>
      </aside>


    </div>
  </div>
  
  <footer>
    <p>SoulAce ¬© 2025 ‚Äî Built with üíô by SynapSix</p>
  </footer>

<script>
const currentUser = {
  id: "{{ current_user_id|default('student-123') }}",
  name: "{{ username|default('Student') }}"
};

/* DOM refs */
const therapistListEl = document.getElementById('therapistList');
const tSlotsPanel = document.getElementById('therapistSlotsPanel');
const tSlotsGrid = document.getElementById('tSlotsGrid');
const tSlotsName = document.getElementById('tSlotsName');
const tSlotsMeta = document.getElementById('tSlotsMeta');
const tSlotsDate = document.getElementById('tSlotsDate');

const proctorListEl = document.getElementById('proctorList');
const pSlotsPanel = document.getElementById('proctorSlotsPanel');
const pSlotsGrid = document.getElementById('pSlotsGrid');
const pSlotsName = document.getElementById('pSlotsName');
const pSlotsMeta = document.getElementById('pSlotsMeta');
const pSlotsDate = document.getElementById('pSlotsDate');

const upcomingListEl = document.getElementById('upcomingList');
const pastListEl = document.getElementById('pastList');

let therapists = [], proctors = [];
let selectedTherapist = null, selectedTherapistSlot = null;
let selectedProctor = null, selectedProctorSlot = null;

/* ---------- Initialization ---------- */
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date().toISOString().split('T')[0];
  if (tSlotsDate) { tSlotsDate.min = today; tSlotsDate.value = today; }
  if (pSlotsDate) { pSlotsDate.min = today; pSlotsDate.value = today; }

  fetchTherapists();
  fetchProctors();
  fetchBookings();

  document.getElementById('refreshTherapists').addEventListener('click', fetchTherapists);
  document.getElementById('refreshProctors').addEventListener('click', fetchProctors);

  if (tSlotsDate) tSlotsDate.addEventListener('change', ()=>{ if (selectedTherapist) loadTherapistSlots(selectedTherapist._id, tSlotsDate.value); });
  if (pSlotsDate) pSlotsDate.addEventListener('change', ()=>{ if (selectedProctor) loadProctorSlots(selectedProctor._id, pSlotsDate.value); });

  document.getElementById('bookingForm').addEventListener('submit', onBookingSubmit);
});

/* ---------- Booking submit ---------- */
async function onBookingSubmit(e) {
  e.preventDefault();

  // UID validation
  const uidInput = document.getElementById('studentUid');
  const uidErr = document.getElementById('uidError');
  const uidVal = (uidInput.value || '').trim();
  const uidPattern = /^\d{10}$/;
  if (!uidPattern.test(uidVal)) {
    uidErr.style.display = 'block';
    uidInput.focus();
    return;
  } else {
    uidErr.style.display = 'none';
  }

  if (!document.getElementById('agreement').checked) {
    alert('Please accept terms.');
    return;
  }

  // Build payload based on selection
  let payload = { user_id: currentUser.id, student_uid: uidVal, concerns: document.getElementById('concerns').value || '' };

  if (selectedTherapist && selectedTherapistSlot) {
    payload.therapist_id = selectedTherapist._id;
    payload.slot_id = selectedTherapistSlot._id;
    payload.date = selectedTherapistSlot.date;
    payload.time = selectedTherapistSlot.time;
  } else if (selectedProctor && selectedProctorSlot) {
    payload.proctor_id = selectedProctor._id;
    payload.slot_id = selectedProctorSlot._id;
    payload.date = selectedProctorSlot.date;
    payload.time = selectedProctorSlot.time;
  } else {
    alert('Please select a therapist or a proctor and pick an available slot.');
    return;
  }

  try {
    const res = await fetch('/api/book', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error || 'Booking failed');

    alert('Booking confirmed!');
    // update UI: mark slot as booked locally and refresh bookings
    if (payload.therapist_id) markSlotAsBookedLocally('therapist', payload.slot_id, true);
    if (payload.proctor_id) markSlotAsBookedLocally('proctor', payload.slot_id, true);
    // clear selections
    selectedTherapistSlot = null;
    selectedProctorSlot = null;
    clearAllSelectedSlots();
    fetchBookings();
  } catch (err) {
    alert('Booking error: ' + err.message);
    // refresh slots for reliability
    if (selectedTherapist) loadTherapistSlots(selectedTherapist._id, tSlotsDate.value);
    if (selectedProctor) loadProctorSlots(selectedProctor._id, pSlotsDate.value);
  }
}

/* ---------- Therapists: fetch & render ---------- */
async function fetchTherapists() {
  therapistListEl.innerHTML = '<div class="empty">Loading therapists‚Ä¶</div>';
  try {
    const res = await fetch('/api/therapists');
    if (!res.ok) throw new Error('Failed to fetch therapists');
    therapists = await res.json();
    renderPeople(therapists, therapistListEl, selectTherapistCard);
  } catch (err) {
    therapistListEl.innerHTML = '<div class="empty">Could not load therapists.</div>';
    console.error(err);
  }
}

/* ---------- Proctors: fetch & render ---------- */
async function fetchProctors() {
  proctorListEl.innerHTML = '<div class="empty">Loading proctors‚Ä¶</div>';
  try {
    const res = await fetch('/api/proctors');
    if (!res.ok) throw new Error('Failed to fetch proctors');
    proctors = await res.json();
    renderPeople(proctors, proctorListEl, selectProctorCard);
  } catch (err) {
    proctorListEl.innerHTML = '<div class="empty">Could not load proctors.</div>';
    console.error(err);
  }
}
// Language switcher
document.getElementById("lang-select").addEventListener("change", function() {
  const lang = this.value;
  document.querySelectorAll("[data-en]").forEach(el => {
    el.textContent = el.dataset[lang] || el.dataset.en;
  });
});

/* ---------- Generic people renderer ---------- */
function renderPeople(items, container, onClick) {
  container.innerHTML = '';
  if (!items || items.length === 0) {
    container.innerHTML = '<div class="empty">No entries.</div>';
    return;
  }
  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'person-card';
    card.dataset.id = item._id;
    card.innerHTML = `
      <div class="avatar">${(item.name||'P').split(' ').map(s=>s[0]).slice(0,2).join('')}</div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${escapeHtml(item.name)}</strong><div class="meta-small">${escapeHtml(item.expertise||item.department||'‚Äî')}</div></div>
          <div class="small">${item.years_experience||item.experience||0} yrs</div>
        </div>
        <div class="meta-small">${escapeHtml(item.location||item.department||'‚Äî')}</div>
      </div>
    `;
    card.addEventListener('click', () => onClick(item, card));
    container.appendChild(card);
  });
}

/* ---------- Select handlers ---------- */
function selectTherapistCard(item, el) {
  // clear selections visual for person-cards
  document.querySelectorAll('.person-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');

  selectedTherapist = item;
  selectedTherapistSlot = null;

  // clear proctor selection visuals to avoid confusion
  selectedProctor = null;
  selectedProctorSlot = null;
  document.querySelectorAll('#proctorList .person-card').forEach(c => c.classList.remove('selected'));
  // show and load therapist slots
  if (tSlotsPanel) tSlotsPanel.style.display = 'block';
  if (tSlotsName) tSlotsName.textContent = item.name;
  if (tSlotsMeta) tSlotsMeta.textContent = `${item.expertise||'‚Äî'} ¬∑ ${item.years_experience||0} yrs ¬∑ ${item.location||'‚Äî'}`;
  loadTherapistSlots(item._id, tSlotsDate.value);
}

function selectProctorCard(item, el) {
  document.querySelectorAll('.person-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');

  selectedProctor = item;
  selectedProctorSlot = null;

  selectedTherapist = null;
  selectedTherapistSlot = null;
  document.querySelectorAll('#therapistList .person-card').forEach(c => c.classList.remove('selected'));

  if (pSlotsPanel) pSlotsPanel.style.display = 'block';
  if (pSlotsName) pSlotsName.textContent = item.name;
  if (pSlotsMeta) pSlotsMeta.textContent = `${item.expertise||item.department||'‚Äî'} ¬∑ ${item.years_experience||0} yrs ¬∑ ${item.department||item.location||'‚Äî'}`;
  loadProctorSlots(item._id, pSlotsDate.value);
}

/* ---------- Load slots from server ---------- */
async function loadTherapistSlots(id, date) {
  tSlotsGrid.innerHTML = '<div class="empty">Loading slots‚Ä¶</div>';
  try {
    const res = await fetch(`/api/therapists/${encodeURIComponent(id)}/slots?date=${encodeURIComponent(date)}`);
    if (!res.ok) throw new Error('Failed to load slots');
    const body = await res.json();
    renderSlotsGrid(body.slots || [], 'therapist');
  } catch (err) {
    tSlotsGrid.innerHTML = '<div class="empty">Could not load slots.</div>';
    console.error(err);
  }
}

async function loadProctorSlots(id, date) {
  pSlotsGrid.innerHTML = '<div class="empty">Loading slots‚Ä¶</div>';
  try {
    const res = await fetch(`/api/proctors/${encodeURIComponent(id)}/slots?date=${encodeURIComponent(date)}`);
    if (!res.ok) throw new Error('Failed to load proctor slots');
    const body = await res.json();
    renderSlotsGrid(body.slots || [], 'proctor');
  } catch (err) {
    pSlotsGrid.innerHTML = '<div class="empty">Could not load slots.</div>';
    console.error(err);
  }
}

/***** Slot selection helpers (integrated) *****/

/**
 * Clear selected-slot visuals from both grids (unless exceptElement provided).
 * Also resets selection state if appropriate.
 */
function clearAllSelectedSlots(exceptElement = null) {
  const allSelected = document.querySelectorAll('.slot.selected-slot');
  allSelected.forEach(el => {
    if (exceptElement && el === exceptElement) return;
    el.classList.remove('selected-slot');
    el.style.boxShadow = '';
  });

  if (!exceptElement) {
    selectedTherapistSlot = null;
    selectedProctorSlot = null;
  } else {
    // if except is in therapist grid, clear proctor selection state
    if (exceptElement.closest && exceptElement.closest('#tSlotsGrid')) {
      selectedProctorSlot = null;
    } else {
      selectedTherapistSlot = null;
    }
  }
}

/**
 * Select a slot element visually and store selection object.
 * kind: 'therapist' or 'proctor'
 */
function selectSlotElement(kind, el, slotObj) {
  clearAllSelectedSlots(el);
  el.classList.add('selected-slot');
  el.style.boxShadow = '0 6px 14px rgba(37,150,120,0.08)';
  if (kind === 'therapist') {
    selectedTherapistSlot = slotObj;
    selectedProctorSlot = null;
  } else {
    selectedProctorSlot = slotObj;
    selectedTherapistSlot = null;
  }
}

/**
 * Render slots for either therapist or proctor.
 */
function renderSlotsGrid(slots, kind) {
  const grid = (kind === 'therapist') ? tSlotsGrid : pSlotsGrid;
  grid.innerHTML = '';
  if (!slots || slots.length === 0) {
    grid.innerHTML = '<div class="empty">No slots.</div>';
    return;
  }

  slots.forEach(s => {
    const div = document.createElement('div');
    div.className = 'slot';
    div.dataset.slotId = s._id;
    div.dataset.time = s.time;
    div.dataset.date = s.date;
    div.textContent = s.time;

    // reset leftover classes/styles
    div.classList.remove('selected-slot','mine','booked','available','disabled');
    div.style.boxShadow = '';

    if (s.status === 'booked') {
      if (s.booked_by && s.booked_by === currentUser.id) {
        div.classList.add('mine','disabled');
      } else {
        div.classList.add('booked','disabled');
      }
    } else {
      div.classList.add('available');
      div.addEventListener('click', function onSlotClick(e) {
        if (div.classList.contains('disabled')) return;
        const slotObj = { _id: s._id, time: s.time, date: s.date };
        selectSlotElement(kind, div, slotObj);
      });
    }

    grid.appendChild(div);
  });
}

/**
 * Mark a slot as booked locally (update visual).
 * kind: 'therapist' | 'proctor'
 */
function markSlotAsBookedLocally(kind, slotId, isMine) {
  const grid = (kind === 'therapist') ? tSlotsGrid : pSlotsGrid;
  const el = grid.querySelector(`[data-slot-id="${slotId}"]`);
  if (!el) {
    // slot not visible -> refresh corresponding grid
    if (kind === 'therapist' && selectedTherapist) loadTherapistSlots(selectedTherapist._id, tSlotsDate.value);
    if (kind === 'proctor' && selectedProctor) loadProctorSlots(selectedProctor._id, pSlotsDate.value);
    return;
  }
  // clear selection visual if it was selected
  if (el.classList.contains('selected-slot')) {
    el.classList.remove('selected-slot');
    el.style.boxShadow = '';
    if (kind === 'therapist') selectedTherapistSlot = null;
    else selectedProctorSlot = null;
  }

  el.classList.remove('available','booked','mine','disabled');
  if (isMine) el.classList.add('mine','disabled'); else el.classList.add('booked','disabled');
}

/* ---------- Bookings: fetch & render ---------- */
async function fetchBookings() {
  upcomingListEl.innerHTML = '<div class="empty">Loading upcoming bookings‚Ä¶</div>';
  pastListEl.innerHTML = '<div class="empty">Loading past bookings‚Ä¶</div>';
  try {
    const res = await fetch(`/api/bookings?user_id=${encodeURIComponent(currentUser.id)}`);
    if (!res.ok) throw new Error('Failed to fetch bookings');
    const data = await res.json();
    renderBookings(data || []);
  } catch (err) {
    upcomingListEl.innerHTML = '<div class="empty">Could not load bookings.</div>';
    pastListEl.innerHTML = '<div class="empty">Could not load bookings.</div>';
    console.error(err);
  }
}
 // Google Translate Script
    function googleTranslateElementInit() {
      new google.translate.TranslateElement(
        {pageLanguage: 'en', includedLanguages: 'en,hi,ur'},
        'google_translate_element'
      );
    }
function renderBookings(bookings) {
  const now = new Date();
  const upcoming = [], past = [];
  bookings.forEach(b => {
    const dt = new Date(`${b.date}T${b.time}:00`);
    if (dt >= now) upcoming.push({ ...b, dt }); else past.push({ ...b, dt });
  });

  function renderList(list, container) {
    container.innerHTML = '';
    if (list.length === 0) { container.innerHTML = '<div class="empty">No bookings.</div>'; return; }
    list.sort((a,b) => a.dt - b.dt);
    list.forEach(b => {
      const node = document.createElement('div');
      node.className = 'booking-item';
      const left = document.createElement('div'); left.className = 'booking-left';
      left.innerHTML = `
        <div class="avatar" style="width:44px;height:44px;border-radius:8px;background:#eef8f4;color:#1b5e3a;display:flex;align-items:center;justify-content:center;font-weight:700">
          ${escapeHtml((b.name||'').split(' ').map(s=>s[0]).slice(0,2).join(''))}
        </div>
        <div style="margin-left:8px">
          <div><strong>${escapeHtml(b.name || (b.therapist_name||b.proctor_name||''))}</strong></div>
          <div class="meta-small">${escapeHtml((b.role||'').toUpperCase())} ¬∑ ${escapeHtml(b.extra || '')}</div>
        </div>`;
      const right = document.createElement('div');
      right.innerHTML = `<div style="text-align:right"><div class="pill">${b.date} ${b.time}</div><div style="font-size:0.85rem;color:#657A74;margin-top:6px">${escapeHtml(b.status || '')}</div></div>`;
      node.appendChild(left); node.appendChild(right);
      container.appendChild(node);
    });
  }

  renderList(upcoming, upcomingListEl);
  renderList(past, pastListEl);
}
 // Google Translate Script
    function googleTranslateElementInit() {
      new google.translate.TranslateElement(
        {pageLanguage: 'en', includedLanguages: 'en,hi,ur'},
        'google_translate_element'
      );
    }
function toggleUserPopup() {
  const popup = document.getElementById('user-popup');
  if (popup) {
    const isVisible = popup.style.display === 'block';
    popup.style.display = isVisible ? 'none' : 'block';
  }
}

function toggleMode() {
  // Add your mode toggle functionality here
  // For example, switching between light/dark themes
  document.body.classList.toggle('dark-mode');
  // You'll need to add corresponding CSS for dark-mode class
}

/* ---------- Utility ---------- */
function escapeHtml(s='') { return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
</script>
<script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>
</html>
