<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SoulAce - Your Mental Health Companion</title>
  <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Zain:wght@400;600&display=swap" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
  <style>
    /* ---------- Reset & Base ---------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #f6f3f0 20%, #e8e1dc 100%);
      color: #6b4e3d;
      min-height: 100vh;
      transition: all 0.4s ease;
    }


    /* ========== HERO ========== */
    .hero {
      text-align:center; padding:60px 20px; background: rgba(255,255,255,0.6);
      backdrop-filter: blur(10px); max-width:900px; margin:40px auto;
      border-radius:20px; border:1px solid rgba(193,123,107,0.2);
    }
    .hero h2 { font-size:2.5rem; margin-bottom:20px; color:#6b4e3d; font-weight:normal; }
    .hero p { font-size:1.2rem; color:#8a8a8a; max-width:700px; margin:0 auto; line-height:1.6; }

    /* ========== MOOD TRACKER ========== */
    .mood-tracker {
      text-align:center; margin:60px 20px; background: rgba(255,255,255,0.4);
      padding:40px; border-radius:20px; backdrop-filter: blur(10px);
      max-width:1000px; margin-left:auto; margin-right:auto;
    }
    .mood-tracker h2 { font-size:2rem; color:#6b4e3d; margin-bottom:30px; font-weight:normal; }

    .moods {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr));
      gap:25px; margin:30px 0; max-width:800px; margin-left:auto; margin-right:auto;
    }
    .mood-option {
      display:flex; flex-direction:column; align-items:center; cursor:pointer;
      padding:15px; border-radius:15px; transition:all 0.3s ease;
    }
    .mood-option:hover { background: rgba(193,123,107,0.06); }
    .mood-btn {
      font-size:30px; border:3px solid #c17b6b; border-radius:50%;
      width:70px; height:70px; display:flex; align-items:center; justify-content:center;
      background:white; margin-bottom:10px; transition:all 0.3s ease;
    }
    .mood-btn:hover { border-color:#2d4a3a; transform:scale(1.06); }
    .label { font-size:14px; font-weight:500; color:#6b4e3d; }

    .download-btn {
      background: linear-gradient(135deg,#c17b6b); color:white; border:none;
      border-radius:25px; padding:12px 25px; font-size:16px; font-weight:500; cursor:pointer;
      margin-top:20px;
    }
    .download-btn:hover { transform:translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }

    /* ========== FEATURES ========== */
    .features { background:#CADBD7; padding:80px 40px; margin-top:60px; }
    .features-container {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:30px;
      max-width:1200px; margin:0 auto;
    }
    .feature-card {
      background: rgba(255,255,255,0.8); padding:30px 20px; border-radius:20px;
      text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.1); transition:all 0.3s ease;
      text-decoration:none; color:inherit; border:1px solid rgba(193,123,107,0.2);
      display:block;
    }
    .feature-card:hover { transform:translateY(-8px); box-shadow:0 15px 35px rgba(0,0,0,0.15); }
    .feature-card img { width:70px; height:70px; object-fit:contain; margin-bottom:15px; }
    .feature-card h3 { font-size:1.3rem; color:#6b4e3d; margin:15px 0; font-weight:500; }
    .feature-card p { color:#8a8a8a; line-height:1.5; font-size:15px; }

    /* ========== CRISIS BUTTON (FAB) ========== */
    .crisis-btn {
      position: fixed; bottom: 30px; right: 30px;
      background: linear-gradient(135deg,#e63946,#ff6b6b);
      color: white; border: none; border-radius: 50px; padding: 15px 25px;
      font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(230,57,70,0.3);
      transition: all 0.3s ease; z-index: 9999;
    }
    .crisis-btn:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(230,57,70,0.4); }

    /* ========== CRISIS POPUP (NEW) ========== */
    .crisis-popup { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:10000;
      align-items:center; justify-content:center; padding:20px; }
    .crisis-popup.active { display:flex; }
    .crisis-popup-content {
      width:100%; max-width:960px; background: #fff; border-radius:14px; overflow:hidden;
      box-shadow:0 30px 80px rgba(0,0,0,0.3); animation: popupIn .18s ease-out;
    }
    @keyframes popupIn { from { transform: translateY(10px); opacity:0 } to { transform: translateY(0); opacity:1 } }
    .crisis-header { display:flex; justify-content:space-between; align-items:center; padding:18px 22px; border-bottom:1px solid rgba(0,0,0,0.06); }
    .crisis-header h2 { margin:0; font-size:1.4rem; color:#6b4e3d; }
    .close-btn { background:transparent; border:none; font-size:26px; cursor:pointer; color:#6b4e3d; }
    .crisis-body { padding:22px; }
    .crisis-options { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:18px; margin-top:14px; }
    .crisis-card { background:#fff; padding:16px; border-radius:12px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); text-align:left; }
    .crisis-icon { font-size:22px; margin-bottom:8px; }
    .phone-input-group { display:flex; gap:8px; margin-top:10px; align-items: center; }
    .phone-input { flex: 1 1 auto; min-width: 0; box-sizing: border-box; padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.1); }
    .request-btn { background:#2d4a3a; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; flex-shrink: 0; white-space: nowrap; }
    .support-card small { color:#666; }
    .crisis-link { display:inline-block; margin-top:8px; color:#c1474a; text-decoration:none; font-weight:600; }  

    /* ========== FOOTER ========== */
    footer { text-align:center; padding:30px 20px; font-size:14px; background:#eee0d1; color:#6b4e3d; border-top:1px solid rgba(193,123,107,0.2); }
    footer a { color:#6b4e3d; text-decoration:none; margin:0 10px; }
    footer a:hover { color:#c17b6b; }

    /* ========== DARK MODE ========== */
    body.dark-mode {
      background: linear-gradient(135deg,#2a2a2a 20%, #1a1a1a 100%); color:#e0e0e0;
    }
    /* (dark-mode rules omitted here for brevity — they remain similar to previously provided CSS) */

    /* ========== RESPONSIVE ========== */
    @media (max-width:768px) {
      header { padding:10px 20px; }
      .header-controls { gap:10px; }
      .hero { margin:20px; padding:40px 20px; }
      .hero h2 { font-size:2rem; }
      .mood-tracker { margin:40px 20px; padding:30px 20px; }
      .moods { grid-template-columns: repeat(auto-fit, minmax(100px,1fr)); gap:20px; }
      .features { padding:60px 20px; }
      .crisis-btn { bottom:20px; right:20px; padding:12px 20px; font-size:14px; }
    }
    /* Confetti canvas sizing handled by JS; ensure it doesn't capture pointer events */
   #confetti-canvas { 
  pointer-events: none;
  will-change: transform; /* hint for smoother animation */
}

  </style>
</head>
<body>

  {% include 'header.html' %}

  <main>
    <section class="hero">
      <h2>Welcome {{ username }} 💛</h2>
      <p>Your safe space for mental wellness is here. Take a moment to check in with yourself, explore our resources, and connect with supportive community when you're ready.</p>
    </section>

    <section class="mood-tracker">
      <h2>How are you feeling?</h2>
      <div class="moods">
        <div class="mood-option" onclick="setMood('Happy')">
          <div class="mood-btn">
            <img src="{{ url_for('static', filename='moods/happy.svg') }}" alt="Happy" class="mood-svg" width="42" height="42">
          </div>
          <div class="label">Happy</div>
        </div>

        <div class="mood-option" onclick="setMood('Calm')">
          <div class="mood-btn">
            <img src="{{ url_for('static', filename='moods/calm.svg') }}" alt="Calm" class="mood-svg" width="42" height="42">
          </div>
          <div class="label">Calm</div>
        </div>

        <div class="mood-option" onclick="setMood('Void')">
          <div class="mood-btn">
            <img src="{{ url_for('static', filename='moods/void.svg') }}" alt="Neutral" class="mood-svg" width="42" height="42">
          </div>
          <div class="label">Neutral</div>
        </div>

        <div class="mood-option" onclick="setMood('Sad')">
          <div class="mood-btn">
            <img src="{{ url_for('static', filename='moods/Sad.svg') }}" alt="Sad" class="mood-svg" width="42" height="42">
          </div>
          <div class="label">Sad</div>
        </div>

        <div class="mood-option" onclick="setMood('Angry')">
          <div class="mood-btn">
            <img src="{{ url_for('static', filename='moods/Angry.svg') }}" alt="Angry" class="mood-svg" width="42" height="42">
          </div>
          <div class="label">Angry</div>
        </div>
      </div>

      <form action="/download_chart" method="get" style="margin-top:12px;">
        <button type="submit" class="download-btn">📊 Download Mood History</button>
      </form>
      <!-- fix the route here, maybe the method -->
       
    </section>

    <section class="features">
      <div class="features-container">
        <a href="{{ url_for('chatbot_page') }}" class="feature-card">
          <img src="{{ url_for('static', filename='chatbot.png') }}" alt="Chatbot">
          <h3>AI Support</h3>
          <p>Chat with our AI guide for coping strategies and next steps.</p>
        </a>

        <a href="{{ url_for('peer') }}" class="feature-card">
          <img src="{{ url_for('static', filename='peer support.png') }}" alt="Peer Support">
          <h3>Peer Support</h3>
          <p>Join moderated forums to share and support each other.</p>
        </a>

        <a href="{{ url_for('assessment') }}" class="feature-card">
          <img src="{{ url_for('static', filename='assessment.png') }}" alt="Assessment">
          <h3>Mental Health Assessment</h3>
          <p>Take a quick GAD-7 + PHQ-9 screening to track your mental health.</p>
        </a>

        <a href="{{ url_for('resources') }}" class="feature-card">
          <img src="{{ url_for('static', filename='wellness.png') }}" alt="Wellness">
          <h3>Wellness Resources</h3>
          <p>Access guides, audios, and videos in your own language.</p>
        </a>

        <a href="{{ url_for('journal') }}" class="feature-card">
          <img src="{{ url_for('static', filename='journal.png') }}" alt="Journal">
          <h3>Journal</h3>
          <p>Pen down your thoughts and feelings of the day.</p>
        </a>

        <a href="{{ url_for('appointment') }}" class="feature-card">
          <img src="{{ url_for('static', filename='appointment.png') }}" alt="Appointment">
          <h3>Confidential Booking</h3>
          <p>Book sessions with counsellors without fear of judgment.</p>
        </a>
      </div>
    </section>
  </main>

  <!-- Floating Crisis Button -->
  <button class="crisis-btn" id="crisis-btn" type="button" onclick="openCrisisPopup()">🚨 Crisis</button>

  <!-- Crisis Popup -->
  <div id="crisisPopup" class="crisis-popup" aria-hidden="true">
    <div class="crisis-popup-content" role="dialog" aria-modal="true" aria-labelledby="crisisTitle">
      <div class="crisis-header">
        <h2 id="crisisTitle">🤗 You Matter</h2>
        <button class="close-btn" aria-label="Close" onclick="closeCrisisPopup()">&times;</button>
      </div>

      <div class="crisis-body">
        <p class="main-message">You are not alone. Everything will work out. 💙</p>
        <p class="sub-message">We're here to support you through this difficult time.</p>

        <div class="crisis-options">
          <div class="crisis-card">
            <div class="crisis-icon">📞</div>
            <h3>Request a Call</h3>
            <p>Enter your number and we'll call you back.</p>
            <div class="phone-input-group">
              <input type="tel" id="userPhone" placeholder="Enter your phone number" class="phone-input">
              <button type="button" onclick="requestCall()" class="request-btn">Call Me</button>
            </div>
          </div>

          <div class="crisis-card">
            <div class="crisis-icon">🏫</div>
            <h3>Campus Helpline</h3>
            <p>24/7 Campus Support</p>
            <a href="tel:+1-555-CAMPUS" class="crisis-link"><strong>+1 (555) CAMPUS</strong></a>
          </div>

          <div class="crisis-card">
            <div class="crisis-icon">🌟</div>
            <h3>National Crisis Line</h3>
            <p>Free, confidential support 24/7</p>
            <a href="tel:988" class="crisis-link"><strong>988 - Suicide & Crisis Lifeline</strong></a>
          </div>

          <div class="crisis-card support-card">
            <div class="crisis-icon">💝</div>
            <h3>You Are Valued</h3>
            <p>Your life has meaning and purpose. Tomorrow can be better than today. Take it one moment at a time.</p>
            <div class="breathing-reminder"><small>Take a deep breath. You've got this. 🌈</small></div>
          </div>
        </div>

        <!-- Action row: Send crisis alert -->
        <div style="margin-top:18px; display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" class="request-btn" onclick="sendCrisis()">📨 Request Immediate Support</button>
          <!-- <button type="button" class="close-btn" onclick="closeCrisisPopup()">Close</button> -->
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>SoulAce © 2025 — Built with 💙 by Synapsix</p>
  </footer>

  <script>

    /* ---------- Confetti celebration ---------- */
(() => {
  const canvas = document.createElement('canvas');
  canvas.id = 'confetti-canvas';
  canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:0;pointer-events:none;z-index:10001;';
  document.body.appendChild(canvas);
  const ctx = canvas.getContext?.('2d');
  if (!ctx) return;

  let W = 0, H = 0, particles = [], animId = null;
  const COLORS = ['#ff5f6d','#ffc371','#7bed9f','#70e1f5','#be9cff','#ffd3e0'];

  function resize() {
    const dpr = Math.max(1, window.devicePixelRatio||1);
    W = window.innerWidth;
    H = Math.min(500, Math.round(window.innerHeight*0.6));
    canvas.width = W*dpr; canvas.height = H*dpr;
    canvas.style.width=W+'px'; canvas.style.height=H+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize',resize); resize();

  function rand(min,max){ return Math.random()*(max-min)+min; }
  function makeParticle(x0=W/2, spread=W*0.9) {
    const x = rand(x0-spread/2, x0+spread/2);
    return {x,y:rand(-40,-10),w:rand(6,12),h:rand(8,14),
      color:COLORS[(Math.random()*COLORS.length)|0],
      vx:rand(-0.4,0.4),vy:rand(1.2,3),rot:rand(0,6.28),rotSpd:rand(-0.2,0.2),
      life:0,ttl:rand(220,420)};
  }
  function draw(p){ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);
    ctx.fillStyle=p.color;ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);ctx.restore();}
  function animate(){
    animId=requestAnimationFrame(animate);ctx.clearRect(0,0,W,H);
    for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.life++;
      p.x+=p.vx;p.y+=p.vy+Math.sin(p.life*0.05);
      p.rot+=p.rotSpd;p.vy+=0.02;draw(p);
      if(p.y>H||p.life>p.ttl)particles.splice(i,1);}
    if(particles.length===0){cancelAnimationFrame(animId);animId=null;ctx.clearRect(0,0,W,H);}
  }
  window.celebrateMood=function(count=80){
    for(let i=0;i<count;i++)particles.push(makeParticle());
    if(!animId)animate();
  };
})();

/* ---------- Mood selection ---------- */
function setMood(mood) {
  console.log('Mood set to:', mood);

  // quick toast instead of alert
  showToast('Mood recorded: ' + mood);

  // 🎉 trigger confetti
  if (mood === 'Happy' || mood === 'Calm') {
    celebrateMood(100); // bigger burst
  } else {
    celebrateMood(60);  // normal burst
  }

  fetch('/save_mood', {method:'POST'});
}

/* ---------- Tiny toast helper ---------- */
function showToast(msg,time=1500){
  let t=document.getElementById('sa-toast');
  if(!t){t=document.createElement('div');t.id='sa-toast';
    Object.assign(t.style,{position:'fixed',top:'20px',left:'50%',transform:'translateX(-50%)',
      background:'rgba(0,0,0,0.8)',color:'#fff',padding:'8px 14px',borderRadius:'14px',
      fontSize:'14px',zIndex:11000,opacity:'0',transition:'opacity .25s'});
    document.body.appendChild(t);}
  t.textContent=msg; t.style.opacity='1'; clearTimeout(t._h);
  t._h=setTimeout(()=>{t.style.opacity='0';},time);
}


    /* ---------- Crisis popup controls ---------- */
    function openCrisisPopup() {
      const p = document.getElementById('crisisPopup');
      p.classList.add('active');
      p.setAttribute('aria-hidden', 'false');
    }
    function closeCrisisPopup() {
      const p = document.getElementById('crisisPopup');
      p.classList.remove('active');
      p.setAttribute('aria-hidden', 'true');
    }

    /* ---------- request call (placeholder) ---------- */
    function requestCall() {
      const phone = document.getElementById('userPhone').value.trim();
      if (!phone) { showError('Please enter your phone number.'); return; }
      // example POST - wire this endpoint server-side
      fetch('/request_call', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ phone })
      })
      .then(res => res.json())
      .then(data => { showSuccess(data.message || 'We will call you shortly.'); closeCrisisPopup(); })
      .catch(err => { console.error(err); showError('Request failed.'); });
    }

    /* ---------- sendCrisis (keeps your original behaviour, with better UI) ---------- */
    async function sendCrisis() {
      try {
        // POST to your server endpoint that logs crisis + optionally sends email
        const response = await fetch('/crisis', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ urgent: true }) });
        const result = await response.json().catch(()=> ({}));
        if (response.ok) {
          showSuccess(result.message || 'Crisis logged. Support team notified.');
        } else {
          showError(result.error || 'Failed to log crisis.');
        }
      } catch (err) {
        console.error('Error:', err);
        showError('Network error, try again!');
      }

      // Try sending an email (your original flow)
      try {
        const res = await fetch('/send_email', { method: 'POST', headers: { 'Content-Type': 'application/json' }});
        const data = await res.json().catch(()=> ({}));
        if (res.ok && data.ok) showSuccess('📧 Crisis email sent!');
        else console.warn('Email not sent:', data);
      } catch (err) {
        console.warn('Email fetch error:', err);
      }

      // close popup after attempt
      closeCrisisPopup();
    }
  </script>

  <!-- Confetti canvas (place near end of body) -->
<canvas id="confetti-canvas" style="position:fixed;top:0;left:0;width:100%;height:0;pointer-events:none;z-index:10001;"></canvas>

</body>
</html>
