<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoulAce - AI Support</title>
  <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Zain:wght@400;600&display=swap" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: 'Georgia', serif; 
      background: linear-gradient(135deg, #f6f3f0 20%, #e8e1dc 100%);
      color: #4a4a4a; 
      min-height: 100vh;
      transition: all 0.4s ease;
    }

    /* ================= HEADER ================= */
    /* ================= MAIN CONTENT ================= */
    main { 
      padding: 2rem; 
      max-width: 900px; 
      margin: 0 auto; 
    }

    h2 { 
      color: #6b4e3d; 
      text-align: center; 
      margin-bottom: 2rem;
      font-size: 2.2rem;
      font-weight: normal;
    }

    .chat-container { 
      background: rgba(255, 255, 255, 0.8);
      border-radius: 20px; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      height: 500px; 
      display: flex; 
      flex-direction: column;
      border: 1px solid rgba(193, 123, 107, 0.2);
      backdrop-filter: blur(10px);
    }

    .chat-header { 
      background:  #c17b6b;
      color: white; 
      padding: 15px 20px; 
      border-radius: 20px 20px 0 0; 
      text-align: center; 
      font-weight: 600; 
    }

    .chat-messages { 
      flex: 1; 
      padding: 20px; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
      gap: 15px; 
    }

    .chat-input-container { 
      padding: 15px 20px; 
      border-top: 1px solid rgba(193, 123, 107, 0.2);
      display: flex; 
      gap: 10px; 
      align-items: center;
      background: rgba(202, 219, 215, 0.3);
      border-radius: 0 0 20px 20px;
    }

    .message { 
      max-width: 70%; 
      padding: 12px 16px; 
      border-radius: 18px; 
      word-wrap: break-word; 
    }

    .user-message { 
      background: #6b4e3d;
      color: white; 
      align-self: flex-end; 
      border-bottom-right-radius: 4px; 
    }

    .bot-message { 
      background: #CADBD7;
      color: #4a4a4a; 
      align-self: flex-start; 
      border-bottom-left-radius: 4px; 
    }

    .message.typing { 
      background: #eee0d1;
      color: #8a8a8a; 
      align-self: flex-start; 
    }

    .typing-indicator { 
      display: flex; 
      gap: 4px; 
    }

    .typing-dot { 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      background: #8a8a8a;
      animation: typing 1.4s infinite; 
    }

    .typing-dot:nth-child(2) { 
      animation-delay: 0.2s; 
    }

    .typing-dot:nth-child(3) { 
      animation-delay: 0.4s; 
    }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    #chat-input { 
      flex: 1; 
      padding: 12px 16px; 
      border: 2px solid #c17b6b;
      border-radius: 25px; 
      font-size: 16px; 
      outline: none;
      background: white;
      color: #4a4a4a;
      font-family: 'Georgia', serif;
    }

    #chat-input:focus { 
      border-color: #6b4e3d;
      box-shadow: 0 0 0 3px rgba(107, 78, 61, 0.1);
    }

    #send-btn { 
      background:  #c17b6b;
      color: white; 
      border: none; 
      padding: 12px 20px; 
      border-radius: 25px; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.3s ease;
      font-size: 16px;
    }

    #send-btn:hover:not(:disabled) { 
      background: #5a4034;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    #send-btn:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
    }

    .welcome-message { 
      text-align: center; 
      color: #8a8a8a;
      font-style: italic; 
      margin: 20px 0;
      background: rgba(202, 219, 215, 0.5);
      padding: 15px;
      border-radius: 15px;
    }

    .quick-responses { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      margin: 10px 0; 
    }

    .quick-btn { 
      background: white;
      border: 1px solid #c17b6b;
      color: #6b4e3d; 
      padding: 8px 14px; 
      border-radius: 20px; 
      cursor: pointer; 
      font-size: 12px; 
      transition: all 0.3s ease;
      font-family: 'Georgia', serif;
    }

    .quick-btn:hover { 
      background: #6b4e3d;
      color: white; 
    }

    /* ================= FOOTER ================= */
    footer { 
      text-align: center; 
      padding: 30px 20px; 
      font-size: 14px; 
      background: #eee0d1;
      color: #6b4e3d;
      border-top: 1px solid rgba(193, 123, 107, 0.2);
      margin-top: 60px;
    }

    /* ================= DARK MODE ================= */
    body.dark { 
      background: linear-gradient(135deg, #2a2a2a 20%, #1a1a1a 100%);
      color: #e0e0e0; 
    }

    body.dark .user-popup { 
      background: #2a2a2a;
      color: #e0e0e0;
      border-color: rgba(224, 224, 224, 0.1);
    }

    body.dark .popup-btn {
      background: #444;
      border-color: #666;
      color: #e0e0e0;
    }

    body.dark .popup-btn:hover {
      background: #666;
      color: white;
    }

    body.dark #lang-select {
      background: #444;
      border-color: #666;
      color: #e0e0e0;
    }

    body.dark h2 {
      color: #e0e0e0;
    }

    body.dark .chat-container { 
      background: rgba(42, 42, 42, 0.8);
      border-color: rgba(224, 224, 224, 0.1);
    }

    body.dark .chat-header { 
      background: #444;
    }

    body.dark .bot-message { 
      background: rgba(68, 68, 68, 0.8);
      color: #e0e0e0; 
    }

    body.dark .user-message {
      background: #5a7a6a;
    }

    body.dark .message.typing {
      background: #444;
      color: #b0b0b0;
    }

    body.dark .typing-dot {
      background: #b0b0b0;
    }

    body.dark .welcome-message {
      background: rgba(68, 68, 68, 0.5);
      color: #b0b0b0;
    }

    body.dark .quick-btn {
      background: #444;
      border-color: #666;
      color: #e0e0e0;
    }

    body.dark .quick-btn:hover {
      background: #666;
      color: white;
    }

    body.dark #chat-input { 
      background: #3a3a3a;
      color: #e0e0e0; 
      border-color: #666;
    }

    body.dark #chat-input:focus {
      border-color: #8a6b5a;
    }

    body.dark .chat-input-container {
      background: rgba(68, 68, 68, 0.5);
      border-color: rgba(224, 224, 224, 0.1);
    }

    body.dark footer { 
      background: #333;
      color: #e0e0e0; 
      border-color: rgba(224, 224, 224, 0.1);
    }

    /* ================= RESPONSIVE ================= */
    @media (max-width: 768px) {
      header {
        padding: 10px 20px;
      }
      
      main {
        padding: 1.5rem 1rem;
      }
      
      h2 {
        font-size: 1.8rem;
      }
      
      .chat-container {
        height: 400px;
      }
      
      .message {
        max-width: 85%;
      }
      
      .quick-responses {
        flex-direction: column;
      }
      
      .quick-btn {
        width: 100%;
      }

      .chat-input-container {
        flex-direction: column;
        gap: 10px;
      }

      #chat-input,
      #send-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
{% include 'header.html' %}

  <main>
    <h2>AI Support Chat ðŸ¤–</h2>
    
    <div class="chat-container">
      <div class="chat-header">
        Your Personal AI Companion
      </div>
      
      <div class="chat-messages" id="chat-messages">
        <div class="welcome-message" >
          ðŸ‘‹ Hi! I'm here to listen and support you. How are you feeling today?
        </div>
        
        <div class="quick-responses">
          <button class="quick-btn" onclick="sendQuickMessage('I\'m feeling anxious')" >I'm feeling anxious</button>
          <button class="quick-btn" onclick="sendQuickMessage('I\'m feeling sad')">I'm feeling sad</button>
          <button class="quick-btn" onclick="sendQuickMessage('I\'m stressed')">I'm stressed</button>
          <button class="quick-btn" onclick="sendQuickMessage('I need someone to talk to')" >I need someone to talk to</button>
        </div>
      </div>

        <div class="chat-input-container">
    <button id="mic-btn" title="Hold to talk" style="background:#fff;border:2px solid #c17b6b;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;">
    ðŸŽ¤
    </button>
    <input type="text" id="chat-input" placeholder="Type your message..." data-en="Type your message..." data-ur="Ø§Ù¾Ù†Ø§ Ù¾ÛŒØºØ§Ù… Ù¹Ø§Ø¦Ù¾ Ú©Ø±ÛŒÚº..." data-hi="à¤…à¤ªà¤¨à¤¾ à¤¸à¤‚à¤¦à¥‡à¤¶ à¤Ÿà¤¾à¤‡à¤ª à¤•à¤°à¥‡à¤‚...">
    <button id="send-btn" onclick="sendMessage()" data-en="Send" data-ur="Ø¨Ú¾ÛŒØ¬ÛŒÚº" data-hi="à¤­à¥‡à¤œà¥‡à¤‚">Send</button>
  </div>

<!--       
      <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type your message..." >
        <button id="send-btn" onclick="sendMessage()">Send</button>
      </div> -->

    </div>
  </main>

  <footer>
    <p >SoulAce Â© 2025 â€“ Built with ðŸ’™ by SynapSix</p>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM ready â€” initializing chat UI and mic');

  // Safe language switcher (only if #lang-select exists)
  const langSelect = document.getElementById('lang-select');
  if (langSelect) {
    langSelect.addEventListener('change', () => {
      const lang = langSelect.value;
      document.querySelectorAll('[data-en]').forEach(el => {
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.placeholder = el.getAttribute('data-' + lang) || el.getAttribute('data-en');
        } else {
          el.textContent = el.getAttribute('data-' + lang) || el.getAttribute('data-en');
        }
      });
    });
  } else {
    console.log('No #lang-select found â€” skipping language switcher init');
  }

  // ---------- DOM references ----------
  const chatInput = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const messagesContainer = document.getElementById('chat-messages');
  const micBtn = document.getElementById('mic-btn');
  let isTyping = false;

  function addMessage(content, isUser = false) {
    if (!messagesContainer) return;
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
    messageDiv.textContent = content;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function showTypingIndicator() {
    if (!messagesContainer) return;
    if (document.getElementById('typing-indicator')) return;
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message typing';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) typingIndicator.remove();
  }

  if (chatInput) {
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !isTyping) {
        e.preventDefault();
        sendMessage();
      }
    });
  }

  async function sendMessage() {
    if (!chatInput) return;
    const message = chatInput.value.trim();
    if (!message || isTyping) return;
    addMessage(message, true);
    chatInput.value = '';

    isTyping = true;
    if (sendBtn) sendBtn.disabled = true;
    chatInput.disabled = true;
    showTypingIndicator();

    try {
      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await response.json();
      setTimeout(() => {
        hideTypingIndicator();
        if (data && data.response) addMessage(data.response);
        else addMessage("I'm here to listen. Could you tell me more about how you're feeling?");
        isTyping = false;
        if (sendBtn) sendBtn.disabled = false;
        if (chatInput) chatInput.disabled = false;
        chatInput && chatInput.focus();
      }, 800);
    } catch (err) {
      console.error('chat send error', err);
      hideTypingIndicator();
      addMessage("I'm having trouble connecting right now, but I'm still here for you. Please try again.");
      isTyping = false;
      if (sendBtn) sendBtn.disabled = false;
      if (chatInput) chatInput.disabled = false;
    }
  }

  window.sendMessage = sendMessage;
  window.sendQuickMessage = function(msg) {
    if (chatInput) chatInput.value = msg;
    sendMessage();
  };

  // ---------- Microphone / MediaRecorder ----------
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  let recordingTimeout = null;

  function setMicUIRecording(on) {
    if (!micBtn) return;
    if (on) {
      micBtn.style.background = '#c17b6b';
      micBtn.style.color = '#fff';
      micBtn.title = 'Click to stop';
    } else {
      micBtn.style.background = '#fff';
      micBtn.style.color = '';
      micBtn.title = 'Hold to talk';
    }
  }

  // Defensive: if micBtn missing just skip mic initialization
  if (micBtn) {
    micBtn.addEventListener('click', async () => {
      try {
        if (!isRecording) {
          // request mic permission and start
          micBtn.disabled = true;
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioChunks = [];
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) audioChunks.push(e.data);
          };
          mediaRecorder.onstop = async () => {
            clearTimeout(recordingTimeout);
            setMicUIRecording(false);
            isRecording = false;
            micBtn.disabled = false;

            const blob = new Blob(audioChunks, { type: audioChunks[0]?.type || 'audio/webm' });
            // stop tracks to release mic
            stream.getTracks().forEach(t => t.stop());
            await sendAudioBlobForTranscription(blob);
          };
          mediaRecorder.start();
          isRecording = true;
          setMicUIRecording(true);
          micBtn.disabled = false;

          // safety: auto-stop after 60s
          recordingTimeout = setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
              mediaRecorder.stop();
              console.warn('Recording auto-stopped after 60s');
            }
          }, 60000);
        } else {
          // stop recording
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
          }
          isRecording = false;
          setMicUIRecording(false);
        }
      } catch (err) {
        console.error('Microphone permission or start error', err);
        addMessage("I can't access your microphone. Please grant permission or try a different browser.", false);
        micBtn.disabled = false;
        setMicUIRecording(false);
        isRecording = false;
      }
    });
  } else {
    console.warn('No mic button (#mic-btn) found in DOM â€” skipping mic init');
  }

  async function sendAudioBlobForTranscription(blob) {
  try {
    if (micBtn) micBtn.disabled = true;
    if (sendBtn) sendBtn.disabled = true;

    const form = new FormData();
    form.append('audio', blob, 'voice.webm');

    // include language if you have one
    const lang = (document.getElementById('lang-select') && document.getElementById('lang-select').value) ? document.getElementById('lang-select').value : null;
    if (lang) form.append('languageCode', lang);

    const res = await fetch('/transcribe', { method: 'POST', body: form });

    let data = {};
    try {
      data = await res.json();
    } catch (jsonErr) {
      console.error('Invalid JSON from /transcribe', jsonErr);
    }

    if (!res.ok) {
      const errMsg = data && data.error ? data.error : `Server error: ${res.status} ${res.statusText}`;
      addMessage(`Transcription failed: ${errMsg}`, false);
      console.error('Transcription failed:', errMsg, data);
      return;
    }

    if (data.transcript) {
      document.getElementById('chat-input').value = data.transcript;
      sendMessage();
    } else {
      const errMsg = data && data.error ? data.error : "No transcript returned";
      addMessage(`I couldn't hear that clearly. (${errMsg})`, false);
      console.warn('No transcript:', data);
    }
  } catch (err) {
    console.error('Error sending audio for transcription', err);
    addMessage("There was an error sending your voice. Check your connection.", false);
  } finally {
    if (micBtn) micBtn.disabled = false;
    if (sendBtn) sendBtn.disabled = false;
  }
}
});
</script>

</body>
</html>